@DOKU_RAND_MOVE_INMAP(ARG,ARG:1,ARG:2,ARG:3 = -1,ARG:4 = -1,ARG:5 = -1) 
;向ARG:4走ARG:1到ARG:2步，如果ARG在ARG:4则向ARG:5，ARG:3为大地图
#DIM DYNAMIC NOWCHARA_TO
#DIM DYNAMIC NOWCHARA_CURRENT_PLACE
#DIM DYNAMIC BOOL_CHECK
BOOL_CHECK = CFLAG:ARG:300
NOWCHARA_TO = ARG:4
NOWCHARA_CURRENT_PLACE = CFLAG:ARG:300
SIF ARG:3 == -1
RETURN 0
;没输入大地图，无效
SIF ARG:4 == -1 || NOWCHARA_CURRENT_PLACE == ARG:4
NOWCHARA_TO = ARG:5
SIF NOWCHARA_TO == -1 || (NAME_FROM_PLACE(NOWCHARA_TO) == "")
RETURN 0
;目的地不存在或已在目的地，无效
FOR X,RAND:(ARG:2-ARG:1)+ARG:1,ARG:2 +1
IF NOWCHARA_CURRENT_PLACE != NOWCHARA_TO
CALLFORM SKIP_MOVE_{ARG:3}(NOWCHARA_TO,NOWCHARA_CURRENT_PLACE)
NOWCHARA_CURRENT_PLACE = RESULT
ELSE
BREAK
ENDIF
NEXT
CFLAG:ARG:300 = NOWCHARA_CURRENT_PLACE
SIF BOOL_CHECK != CFLAG:ARG:300 && CFLAG:ARG:300 == CFLAG:0:300
CALL DOKU_KM_RENEW_TARGET(ARG)
RETURN 1

@DOKU_RAND_MOVE_INMAP_2(ARG,ARG:1,ARG:2,ARG:3 = -1,ARG:4 = -1)
;向ARG:3走ARG:1到ARG:2步，如果ARG在ARG:3则向ARG:4
SIF ARG:3 / 100 != ARG:4 / 100
RETURN 0
;ARG:3和ARG:4不在同一张大地图
CALL DOKU_RAND_MOVE_INMAP(ARG,ARG:1,ARG:2,ARG:3/100,ARG:3,ARG:4)
RETURN 1

@DOKU_MOVE(ARG,ARG:1,ARG:2=0,ARG:3=1)
#DIM DYNAMIC BOOL_CHECK
BOOL_CHECK = CFLAG:ARG:300
;ARG-移动者
;ARG:1-目标地点
;ARG:2-是否禁止自动坐标转换（例如对于外出地图，946桥会转换成920）
;这个函数就只负责移动，其他什么检测都不负责，所以是强制的移动，使用时请注意
;更新：ARG:3（可省略）-为0则不更新target。这是为了性能优化
IF ARG
IF CFLAG:ARG:320 && ARG:1/100 == CFLAG:0:300 / 100
CFLAG:ARG:12 = CFLAG:0:12 ;同行中智能改CFLAG12
IF ARG:1/100 == CFLAG:0:311 / 100
CFLAG:300 = ARG:1
ELSE
IF ARG:2
CFLAG:ARG:300 = ARG:1 ;禁用自动转换
ELSE
CFLAG:ARG:300 = GET_MAP_REPLACEMENT(ARG:1) ;自动转换
ENDIF
SIF !FLAG:73
FLAG:73 = ARG
ENDIF
ELSE
CFLAG:ARG:320 = 0
SIF FLAG:73 == ARG
FLAG:73 = 0
CFLAG:ARG:12 = CFLAG:0:311 / 100
IF ARG:1/100 == CFLAG:0:311 / 100
CFLAG:ARG:300 = ARG:1 ;主地图直接移动
ELSE ;非主地图
IF ARG:2
CFLAG:ARG:300 = ARG:1 ;禁用自动转换
ELSE
CFLAG:ARG:300 = GET_MAP_REPLACEMENT(ARG:1) ;替换地点
ENDIF
ENDIF
ENDIF
ELSE ;对玩家进行操作
SIF ARG:1/100 != CFLAG:0:12
CFLAG:0:12 = ARG:1/100
IF CFLAG:0:12 == CFLAG:0:311 / 100
CFLAG:0:300 = ARG:1
ELSE
CFLAG:0:300 = GET_MAP_REPLACEMENT(ARG:1)
SIF NAME_FROM_PLACE(CFLAG:0:300) == "不明"
THROW DOKU_MOVE：不明地点！
ENDIF
SIF CFLAG:0:300 % 100 == 99
THROW 不要把玩家移动到隙间里！
ENDIF

IF ARG 
IF ARG:1 /100 == CFLAG:0:311 /100
CFLAG:ARG:359 = 1
ELSE
CFLAG:ARG:359 = 0
ENDIF
ENDIF
;来访相关，加点料

SIF ARG:3 && ((BOOL_CHECK != CFLAG:ARG:300 && CFLAG:ARG:300 == CFLAG:0:300)||ARG==0)
CALL DOKU_KM_RENEW_TARGET(ARG)
RETURN 1

@DOKU_CHECK_PLACE(ARG,ARG:1)
#FUNCTION
#LOCALSIZE 1
#LOCALSSIZE 1
RETURNF (CFLAG:0:311 / 100 == ARG:1 / 100 && ARG == ARG:1) || (CFLAG:0:311 / 100 != ARG:1 / 100 && ARG == GET_MAP_REPLACEMENT(ARG:1))

@DOKU_REPLACE_PLACE(ARG)
#FUNCTION
#LOCALSIZE 1
#LOCALSSIZE 1
SIF CFLAG:0:311 / 100 == ARG / 100
RETURNF ARG
RETURNF GET_MAP_REPLACEMENT(ARG)

@DOKU_FIND_NEXT_PLACE(ARG,ARG:1)
;从ARG到ARG:1
SIF ARG/100 != ARG:1 / 100
THROW DOKU_FIND_NEXT_PLACE：不支持跨地图寻路
SIF ARG/100 != CFLAG:0:311 / 100
THROW DOKU_FIND_NEXT_PLACE：不支持主地图外寻路
VARSET RESULT
TRYCALLFORM SKIP_MOVE_{ARG/100}(ARG:1,ARG)
SIF RESULT
RETURN RESULT
RETURN ARG