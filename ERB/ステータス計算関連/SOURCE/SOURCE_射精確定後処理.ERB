;射精確定後の処理
@EJAC_CHECK_AFTER(ARG)
#DIM 射精回数
#DIM 過剰射精

VARSET 射精回数
VARSET 過剰射精
;ARG 射精する人
IF !TCVAR:ARG:要去了
	IF BASE:ARG:射精 > MAXBASE:ARG:射精
		IF BASE:ARG:勃起 < 1000
			BASE:ARG:射精 = MAXBASE:ARG:射精 - 1
		ELSE
			TCVAR:ARG:要去了 = 1
		ENDIF
	ENDIF
	RETURN 0
ELSEIF TEQUIP:ARG:挑逗モード && ARG != MASTER
	TCVAR:ARG:挑逗回数 += 2
	RETURN 0
ENDIF

BASE:ARG:精力 = MAX(0, BASE:ARG:精力) ;bug fix custom code, failsafe

;射精(絶頂)回数
射精回数 = MIN(BASE:ARG:射精 / MAXBASE:ARG:射精, (100 + BASE:ARG:精力) / 100)

NOWEX:ARG:射精量 = BASE:ARG:射精 * 10 / (ABL:ARG:Ｃ感覚 / 2 + 10) / 100
IF SHOOTINGSTAR == 0
	NOWEX:ARG:射精量 = NOWEX:ARG:射精量 * 10 / (ABL:ARG:Ｃ感覚 / 2 + 10)
ELSE
	NOWEX:ARG:射精量 = NOWEX:ARG:射精量 * 10 / (ABL:ARG:Ｃ感覚 / 2 + 10) * SHOOTINGSTAR_NUM
ENDIF

IF NOWEX:ARG:射精量 > BASE:ARG:精力
	過剰射精 = NOWEX:ARG:射精量 - BASE:ARG:精力
ENDIF

IF 過剰射精
	IF TFLAG:劇毒身軀
		DOWNBASE:ARG:体力 += 過剰射精 * 1
	ELSE
		DOWNBASE:ARG:体力 += 過剰射精 * 1 / 2
	ENDIF
ENDIF

BASE:ARG:精力 = MAX(0, BASE:ARG:精力 - NOWEX:ARG:射精量)
TCVAR:ARG:要去了 = 0
STAIN:ARG:Ｐ |= 4

;魔改射精后增加属性上限
SIF BUp:9==1||(!ARG&&BUp:9==2)
	CALL EjBUp(ARG)

;BASEの処理
BASE:ARG:射精 = 0

CSTR:ARG:射精後処理用 = %CSTR:ARG:射精判定用%
TCVAR:ARG:已射精部位FLAG = TCVAR:ARG:射精部位

;異常経験、射精経験、精液経験
;女性器がある場合？
SIF !EXP:ARG:射精経験 && TALENT:ARG:性別 & 1
	EXP:ARG:異常経験 += 1

EXP:ARG:絶頂経験 ++ 
EXP:ARG:射精経験 += 射精回数

NOWEX:ARG:射精 += 射精回数
EX:ARG:射精 += 射精回数
TCVAR:ARG:挑逗回数 = 0
TEQUIP:ARG:挑逗モード = 0
SIF AT_HOME(ARG)
	YOGORE:(CFLAG:ARG:現在位置) += 射精回数 * 50

IF TFLAG:劇毒身軀
	DOWNBASE:ARG:体力 += LIMIT(NOWEX:ARG:射精量 / 4, 30, 300)
	DOWNBASE:ARG:気力 += LIMIT(NOWEX:ARG:射精量 / 2, 40, 400)
ELSE
	DOWNBASE:ARG:体力 += LIMIT(NOWEX:ARG:射精量 / 8, 10, 100)
	DOWNBASE:ARG:気力 += LIMIT(NOWEX:ARG:射精量 / 4, 20, 200)
ENDIF

;MASTERでなければBASEやSOURCE等の処理を入れる
SIF ARG == MASTER
	RETURN 0

IF EXP:ARG:射精経験 < EXPLV:1
	SOURCE:ARG:露出 += 5000 * (射精回数 + 1) / 2
	SOURCE:ARG:屈従 += 2500 * (射精回数 + 1) / 2
	SOURCE:ARG:不潔 += 200 * (射精回数 + 1) / 2
ELSEIF EXP:ARG:射精経験 < EXPLV:2
	SOURCE:ARG:露出 += 2500 * (射精回数 + 1) / 2
	SOURCE:ARG:屈従 += 2000 * (射精回数 + 1) / 2
	SOURCE:ARG:不潔 += 150 * (射精回数 + 1) / 2
ELSEIF EXP:ARG:射精経験 < EXPLV:3
	SOURCE:ARG:露出 += 1000 * (射精回数 + 1) / 2
	SOURCE:ARG:屈従 += 800 * (射精回数 + 1) / 2
	SOURCE:ARG:不潔 += 100 * (射精回数 + 1) / 2
ELSEIF EXP:ARG:射精経験 < EXPLV:4
	SOURCE:ARG:露出 += 800 * (射精回数 + 1) / 2
	SOURCE:ARG:屈従 += 600 * (射精回数 + 1) / 2
	SOURCE:ARG:不潔 += 50 * (射精回数 + 1) / 2
ELSEIF EXP:ARG:射精経験 < EXPLV:5
	SOURCE:ARG:露出 += 400 * (射精回数 + 1) / 2
	SOURCE:ARG:屈従 += 400 * (射精回数 + 1) / 2
	SOURCE:ARG:不潔 += 10 * (射精回数 + 1) / 2
ELSE
	SOURCE:ARG:露出 += 200 * (射精回数 + 1) / 2
	SOURCE:ARG:屈従 += 250 * (射精回数 + 1) / 2
ENDIF

;-------------------------------------------------
;調教対象の射精チェック
;-------------------------------------------------
@TARGET_EJAC_CHECK(ARG)

;男性器がなければ返回
SIF !HAS_PENIS(ARG)
	RETURN 0
LOCAL = (CUP:ARG:快Ｃ + CUP:ARG:快Ｖ + CUP:ARG:快Ａ + CUP:ARG:快Ｂ) / 4
;自制心
SIF TALENT:ARG:自制心
	LOCAL /= 2
;接受快感
SIF TALENT:ARG:快感応答 > 0
	TIMES LOCAL , 1.20
;否定快感（淫乱、娼婦で無効）
SIF TALENT:ARG:快感応答 < 0 && !TALENT:ARG:淫乱
	TIMES LOCAL , 0.80
;媚薬
SIF (TCVAR:ARG:媚薬 || IsInsenceValid(ARG)) && ARG != MASTER
	LOCAL *= 2
;仙香玉兎
SIF IsInsenceValid(ARG)
	LOCAL *= 2
;利尿剤
SIF TCVAR:ARG:利尿剤
	LOCAL /= 2
;睡眠中
SIF CFLAG:ARG:睡眠
	LOCAL /= 2
BASE:ARG:射精 += LOCAL
;SIF BASE:ARG:射精 > MAXBASE:ARG:射精
;	BASE:ARG:射精 = MAXBASE:ARG:射精 - 1

;射精処理の角色別ターミナル
@SAMEN_SHOOT(射精した角色番号)
#DIM 射精した角色番号
#DIM 射精された角色番号

FOR 射精された角色番号, 0, CHARANUM
	SIF SAMEN_DIRECTION2(射精した角色番号, 射精された角色番号)
		CALL SAMEN_SHOOT2(射精した角色番号, 射精された角色番号)
NEXT

;部位別処理
@SAMEN_SHOOT2(SENDER, RECEIVER)
#DIM SENDER
#DIM RECEIVER
#DIM 强行反感
#DIM 强行恐怖
#DIM 信頼减少
#DIM 好感度减少
#DIM 欲求不満解消係数
#DIM 路人子用

CFLAG:RECEIVER:(SENDER+2500) += NOWEX:SENDER:射精量

IF !SENDER && CFLAG:RECEIVER:诶嘿嘿 == 2
	SOURCE:RECEIVER:達成 += NOWEX:SENDER:射精 * 150
	SOURCE:RECEIVER:征服 += NOWEX:SENDER:射精 * 150
	SIF !(NOWEX:RECEIVER:Ｃ絶頂 + NOWEX:RECEIVER:Ｖ絶頂 + NOWEX:RECEIVER:Ａ絶頂 + NOWEX:RECEIVER:Ｂ絶頂 + NOWEX:RECEIVER:Ｍ絶頂)
		SOURCE:RECEIVER:征服 += NOWEX:SENDER:射精 * 100
ENDIF
IF !SENDER && TALENT:RECEIVER:路人 == 1
	路人子用 = MIN(NOWEX:SENDER:射精,3)
	SELECTCASE TCVAR:SENDER:已射精部位FLAG
		CASE 1
			SIF ABL:RECEIVER:膣 < 路人子用
				CALL ChangeABL(RECEIVER, "膣", 1)
		CASE 2
			SIF ABL:RECEIVER:肛門 < 路人子用
				CALL ChangeABL(RECEIVER, "肛門", 1)
		CASE 3
			SIF ABL:RECEIVER:指 < 路人子用
				CALL ChangeABL(RECEIVER, "指", 1)
		CASE 4
			SIF ABL:RECEIVER:舌 < 路人子用
				CALL ChangeABL(RECEIVER, "舌", 1)
		CASE 4
			SIF ABL:RECEIVER:胸 < 路人子用
				CALL ChangeABL(RECEIVER, "胸", 1)
	ENDSELECT
ENDIF

IF TEQUIP:SENDER:避孕套 ;&& TEQUIP:TARGET:50 == PLAYER
	;ゴムを外す
	TEQUIP:SENDER:避孕套 = 0
	IF RECEIVER
		SELECTCASE TCVAR:SENDER:已射精部位FLAG
			CASE 1
				CFLAG:RECEIVER:积攒度 += ABL:RECEIVER:膣射中毒 * NOWEX:SENDER:射精 * 15
			CASE 2
				CFLAG:RECEIVER:积攒度 += ABL:RECEIVER:肛射中毒 * NOWEX:SENDER:射精 * 15
		ENDSELECT
	ENDIF
	;接触のリセット
	;CALL 挿入解除(RECEIVER) ;custom code, comment out because this part creates a ton of problems, it messes up the detection and proper dialogue calls are not executed
	TFLAG:套套内 = NOWEX:SENDER:射精量
	IF CFLAG:RECEIVER:自動ゴム && ITEM:避孕套 ;&& SENDER == MASTER ;com custom code
		ITEM:避孕套 --
		TEQUIP:SENDER:避孕套 = 1
	ELSE ;custom code (above puts the condom automatically so sex continues, here we disengage)
		;send a flag to cancel all insertions to emulate the function above, but after all the stuff is processed, wrap it up at source.erb
		SEX_DISENGAGE = RECEIVER + 1
	ENDIF
ELSE
	;TCVAR:12 射精部位フラグ（1=膣内 2=肛門 3=手淫 4=口淫 5=乳交 6=素股 7=足交 8=体表 9=肛門奉仕 10=道具 11=触手）
	SIF TEQUIP:SENDER:12 ;com custom code, set to onahole ejaculation if equipped
		TCVAR:SENDER:射精した箇所フラグ = 10
	
[SKIPSTART]
	;pullout promise patch 我觉得没必要用
	;note - the original was broken as player doesn't receive 外に出すから and doesn't need to (and it checked pc for some reason), this part is processed first, then the SOURCE_射精確定前処理.ERB part, then the orgasm description
				
	;custom edit - modified from chance-based to player input
	IF GROUPMATCH(TCVAR:SENDER:射精した箇所フラグ, 1, 50) && !TCVAR:RECEIVER:ピル && TCVAR:RECEIVER:外に出すから == 1 ;if on pill, just let it happen harmlessly
		LOCAL = LIMIT(MULTIPLY(RAND(7000, 10001), 100 - LIMIT(ABL:技巧 + ABL:膣 - GETEXPLV(EXP:MASTER:GETNUM(EXP, "挿入経験"), 12) - ABL:PLAYER:技巧 - TALENT:PLAYER:自制心*3, 0, 10)*10) - (TALENT:PLAYER:絶倫 || EXP:PLAYER:Ｖ性交経験 <= 100)*3000, 1500, 10000)
		REDRAW 1
		PRINTFORML  [0] Pull out!
		PRINTFORML  [1] Give up
		TINPUT LOCAL, 100, 1, "Time Out!"
		;nakadashi happens
		IF RESULT
			SIF RESULT == 1
				PRINTFORML You submit to the overwhelming desire, forgetting about your promise...
		ELSE
			;pull out, set to outside
			TCVAR:SENDER:射精した箇所フラグ = 8
			nPulledOut = 1
			SEX_DISENGAGE = RECEIVER + 1
		ENDIF
	ENDIF
[SKIPEND]
;--------------------------------

SELECTCASE TCVAR:SENDER:已射精部位FLAG
	;膣内
	CASE 1
		EXP:RECEIVER:精液経験 += NOWEX:SENDER:射精 * 2
		EXP:RECEIVER:膣射経験 += NOWEX:SENDER:射精 * 2
		STAIN:RECEIVER:Ｖ |= 4
		STAIN:RECEIVER:膣内 |= 4
		TCVAR:RECEIVER:V被中出FLAG = 2
		TCVAR:RECEIVER:Vに中出しした角色の番号 = SENDER
		IF FLAG:70 && CFLAG:RECEIVER:344 == 0
			CFLAG:RECEIVER:膣内射精 = 2
		ELSE
			CFLAG:RECEIVER:膣内射精 = 1
		ENDIF
		NOWEX:RECEIVER:膣内精液 = NOWEX:SENDER:射精量
		EX:RECEIVER:膣内精液 += NOWEX:RECEIVER:膣内精液
		欲求不満解消係数 = 800 / MIN(100 + ABL:RECEIVER:膣射中毒 * 10,200)
		SIF NOWEX:RECEIVER:膣内精液 > 0
			CFLAG:RECEIVER:积攒度 -= SQRT(NOWEX:RECEIVER:膣内精液) * 欲求不満解消係数
		CFLAG:RECEIVER:累計膣内精液 += NOWEX:RECEIVER:膣内精液
		CFLAG:SENDER:累計膣内射精 += NOWEX:RECEIVER:膣内精液
		CFLAG:RECEIVER:(SENDER+3000) += NOWEX:RECEIVER:膣内精液
		CALL POISONBODY(RECEIVER, SENDER, 1)
		;SIF !TCVAR:RECEIVER:口服避孕薬
		;PRINTFORML %CALLNAME:SENDER%が%CALLNAME:RECEIVER%に{NOWEX:RECEIVER:膣内精液}出した
		CALL SAMEN_SHOOT3(NOWEX:RECEIVER:膣内精液 , SENDER, RECEIVER)
		IF SHIRAHU(RECEIVER)
			TCVAR:RECEIVER:種付けられ自覚 = 1
			CFLAG:RECEIVER:種付けられ自覚 = 1
		ENDIF
		IF SHIRAHU(SENDER) && SENDER != MASTER
			TCVAR:SENDER:種付け自覚 = 1
		ENDIF
		IF TCVAR:RECEIVER:强行
			IF TALENT:RECEIVER:路人 == 1
				CSTR:RECEIVER:路人子プロフィール２ = %REPLACE(@"%CSTR:RECEIVER:路人子プロフィール２%","现在已经老实了","、被膣内射精了")%
				SIF !STRCOUNT(CSTR:RECEIVER:路人子プロフィール２, "膣内射精了")
					CSTR:RECEIVER:路人子プロフィール２ = %REPLACE(@"%CSTR:RECEIVER:路人子プロフィール２%","处女被夺走了","处女被夺走之后、被膣内射精了")%
				IF EX:RECEIVER:膣内精液 >= 300 && !STRCOUNT(CSTR:RECEIVER:路人子プロフィール２, "充分")
					CSTR:RECEIVER:路人子プロフィール２ = %REPLACE(@"%CSTR:RECEIVER:路人子プロフィール２%","膣内射精了","注入了充分的精液")%
				ENDIF
				IF 路人子初期Ｖ性交経験 + 10 <= EXP:RECEIVER:Ｖ性交経験
					IF !STRCOUNT(CSTR:RECEIVER:路人子プロフィール２, "打倒在地然后")
						CSTR:RECEIVER:路人子プロフィール２ = %REPLACE(@"%CSTR:RECEIVER:路人子プロフィール２%","膣内射精了", "打倒在地然后膣内射精了")%
					ENDIF
					IF 路人子初期Ｖ性交経験 + 15 <= EXP:RECEIVER:Ｖ性交経験 && !STRCOUNT(CSTR:RECEIVER:路人子プロフィール２, "散々")
						CSTR:RECEIVER:路人子プロフィール２ = %REPLACE(@"%CSTR:RECEIVER:路人子プロフィール２%","打倒在地然后", "蛮横地打倒在地然后")%
					ENDIF
				ENDIF
				IF MARK:RECEIVER:快楽刻印 && !STRCOUNT(CSTR:RECEIVER:路人子プロフィール２, "绝顶")
					CSTR:RECEIVER:路人子プロフィール２ = %REPLACE(@"%CSTR:RECEIVER:路人子プロフィール２%","打倒在地然后", "打倒在地然后绝顶的同时被")%
				ENDIF
				IF MARK:RECEIVER:快楽刻印 && !STRCOUNT(CSTR:RECEIVER:路人子プロフィール２, "就那样狂乱地")
					CSTR:RECEIVER:路人子プロフィール２ = %REPLACE(@"%CSTR:RECEIVER:路人子プロフィール２%","绝顶的同时", "就那样狂乱绝顶的同时")%
				ENDIF
			ENDIF
			SELECTCASE ABL:RECEIVER:膣射中毒
				CASE IS < 3
					强行反感 = 100000
					好感度减少 = NOWEX:SENDER:射精 * RAND:50 + NOWEX:SENDER:射精 * RAND:50
					信頼减少 = NOWEX:SENDER:射精 * RAND:20 + NOWEX:SENDER:射精 * RAND:20
					强行恐怖 = NOWEX:RECEIVER:膣内精液 * 5
				CASE 3 TO 5
					强行反感 = 50000
					好感度减少 = NOWEX:SENDER:射精 * RAND:30 + NOWEX:SENDER:射精 * RAND:30
					信頼减少 = NOWEX:SENDER:射精 * RAND:15 + NOWEX:SENDER:射精 * RAND:15
					强行恐怖 = NOWEX:RECEIVER:膣内精液 * 3
				CASEELSE
					强行反感 = 10000
					好感度减少 = NOWEX:SENDER:射精 * RAND:10 + NOWEX:SENDER:射精 * RAND:10
					信頼减少 = NOWEX:SENDER:射精 * RAND:10 + NOWEX:SENDER:射精 * RAND:10
					强行恐怖 = NOWEX:RECEIVER:膣内精液
			ENDSELECT
			IF CFLAG:RECEIVER:生理周期 == 7
				强行反感 *= 2
				强行恐怖 *= 2
				好感度减少 *= 2
				信頼减少 *= 2
			ENDIF
			IF CFLAG:RECEIVER:强行内射 > 1
				强行反感 *= 2
				强行恐怖 *= 2
				好感度减少 *= 2
				信頼减少 *= 2
			ENDIF
			SOURCE:RECEIVER:反感 += 强行反感
			IF CFLAG:RECEIVER:强行内射 > 1
				CFLAG:RECEIVER:强行内射 = 3
			ELSE
				CFLAG:RECEIVER:强行内射 = 1
			ENDIF
			TFLAG:好感度管理 -= 好感度减少
			CALL CHANGE_CFLAG(4,RECEIVER,信頼减少 * (-1))
		ELSEIF TCVAR:RECEIVER:外に出すから && !TCVAR:PLAYER:コンドーム && !TCVAR:ピル ;pullout promise patch + custom - do not apply if protection was used
			强行反感 = 5000
			强行恐怖 = NOWEX:RECEIVER:膣内精液
			好感度减少 = NOWEX:SENDER:射精 * RAND:10 + NOWEX:SENDER:射精 * RAND:10
			信頼减少 = NOWEX:SENDER:射精 * RAND:10 + NOWEX:SENDER:射精 * RAND:10
			;危険日
			IF CFLAG:RECEIVER:生理周期 == 7
				强行反感 *= 10
				强行恐怖 *= 10
				好感度减少 *= 3
				信頼减少 *= 3
			;排卵日
			ELSEIF CFLAG:RECEIVER:生理周期 == 8
				强行反感 *= 5
				强行恐怖 *= 5
				好感度减少 *= 2
				信頼减少 *= 2
			ELSE
				强行反感 *= 5
				强行恐怖 *= 5
				好感度减少 *= 1
				信頼减少 *= 1
			ENDIF
			
			PRINTFORML 原本%CALLNAME:SENDER%许诺会射在外面才同意不戴套的，结果却食言了…%CALLNAME:RECEIVER%很生气
			PRINTW 
			
			SOURCE:RECEIVER:反感 += 强行反感
			TFLAG:好感度管理 -= 好感度减少
			CALL CHANGE_CFLAG(4,RECEIVER,信頼减少 * (-1))
		ENDIF

	;肛門
	CASE 2
		EXP:RECEIVER:精液経験 += NOWEX:SENDER:射精 * 2
		EXP:RECEIVER:肛射経験 += NOWEX:SENDER:射精 * 2
		STAIN:RECEIVER:Ａ |= 4
		STAIN:RECEIVER:腸内 |= 4
		;中出し表示用
		TCVAR:RECEIVER:A被中出FLAG = 2
		TCVAR:RECEIVER:Aに中出しした角色の番号 = SENDER
		IF FLAG:70 && CFLAG:RECEIVER:344 == 0
			CFLAG:RECEIVER:肛門射精 = 2
		ELSE
			CFLAG:RECEIVER:肛門射精 = 1
		ENDIF
		NOWEX:RECEIVER:肛門内精液 = NOWEX:SENDER:射精量
		EX:RECEIVER:肛門内精液 += NOWEX:SENDER:射精量
		欲求不満解消係数 = 800 / MIN(100 + ABL:RECEIVER:肛射中毒 * 10,200)
		CFLAG:RECEIVER:积攒度 -= SQRT(NOWEX:RECEIVER:肛門内精液) * 欲求不満解消係数
		CFLAG:RECEIVER:累計肛門精液 += NOWEX:SENDER:射精量
		CFLAG:SENDER:累計肛門射精 += NOWEX:SENDER:射精量
		CFLAG:RECEIVER:(SENDER+3500) += NOWEX:RECEIVER:肛門内精液
		CALL POISONBODY(RECEIVER, SENDER, 2)
	;手淫
	CASE 3
		EXP:RECEIVER:精液経験 += 1 + NOWEX:SENDER:射精
		STAIN:RECEIVER:手 |= 4
		IF FLAG:70 && CFLAG:RECEIVER:344 == 0
			CFLAG:RECEIVER:手上精液 = 2
		ELSE
			CFLAG:RECEIVER:手上精液 = 1
		ENDIF
		IF ABL:RECEIVER:精液中毒 > 2 && ABL:RECEIVER:技巧 > 2
			EXP:RECEIVER:精飲経験 ++
			CFLAG:RECEIVER:累計精飲 += NOWEX:SENDER:射精量 / 2
			CFLAG:RECEIVER:积攒度 -= NOWEX:SENDER:射精量 * ABL:RECEIVER:精液中毒 / 10 * (TALENT:RECEIVER:精愛味覚 + 1)
			CALL POISONBODY(RECEIVER, SENDER, 31)
		ELSE
			CALL POISONBODY(RECEIVER, SENDER, 3)
		ENDIF
		;接触のリセット
		TEQUIP:SENDER:指接触部位 = 0
	;口淫
	CASE 4
		EXP:RECEIVER:精液経験 += NOWEX:SENDER:射精 * 3
		STAIN:RECEIVER:口 |= 4
		IF FLAG:70 && CFLAG:RECEIVER:344 == 0
			CFLAG:RECEIVER:口内精液 = 2
		ELSE
			CFLAG:RECEIVER:口内精液 = 1
		ENDIF
		;深喉插入
		欲求不満解消係数 = 800 / MIN(100 + ABL:RECEIVER:精液中毒 * 10,200)
		IF TALENT:RECEIVER:精愛味覚
			SOURCE:RECEIVER:快Ｍ += NOWEX:SENDER:射精 * 10
			欲求不満解消係数 += 1
		ENDIF
		IF SELECTCOM == 140
			EXP:RECEIVER:精飲経験 += NOWEX:SENDER:射精 * 3
			CFLAG:RECEIVER:累計精飲 += NOWEX:SENDER:射精量
			CFLAG:SENDER:累計口内射精 += NOWEX:SENDER:射精量
		ELSEIF  RAND:(MIN(60, EXP:RECEIVER:精飲経験 + 1)) > 10 + RAND:30
			EXP:RECEIVER:精飲経験 += NOWEX:SENDER:射精 * 3
			CFLAG:RECEIVER:累計精飲 += NOWEX:SENDER:射精量
			CFLAG:SENDER:累計口内射精 += NOWEX:SENDER:射精量
		ELSE
			EXP:RECEIVER:精飲経験 += NOWEX:SENDER:射精
			CFLAG:RECEIVER:累計精飲 += NOWEX:SENDER:射精量 / 3
			CFLAG:SENDER:累計口内射精 += NOWEX:SENDER:射精量
			欲求不満解消係数 /= 2
		ENDIF
		CALL POISONBODY(RECEIVER, SENDER, 4)
		CFLAG:RECEIVER:积攒度 -= SQRT(NOWEX:SENDER:射精量) * 欲求不満解消係数 / 4

		;接触のリセット
		TEQUIP:SENDER:口接触部位 = 0
	;乳交
	CASE 5
		EXP:RECEIVER:精液経験 += NOWEX:SENDER:射精 * 3
		CFLAG:RECEIVER:累計精浴 += NOWEX:SENDER:射精量
		CFLAG:SENDER:累計精浴射精 += NOWEX:SENDER:射精量
		CALL POISONBODY(RECEIVER, SENDER, 5)
		STAIN:RECEIVER:5 |= 4
		IF FLAG:70 && CFLAG:RECEIVER:344 == 0
			CFLAG:RECEIVER:脸上精液 = 2
		ELSE
			CFLAG:RECEIVER:脸上精液 = 1
		ENDIF
		;TFLAG:特殊COM = 12 に該当するものがCSVに書いてない
		;(1=六九式 2=岩清水 3=Gスポット刺激 4=乱牡丹 5=手淫口交 6= 7= 8= 六九式乳交 13=交互挿入 )
		;TFLAGS.txtと書いてあることが違う（TFLAG:12 逆強姦継続フラグ（VA共通））
		;	→嫌な予感
		SIF TFLAG:特殊COM == 12
			STAIN:RECEIVER:口 |= 4
		;接触のリセット
		TEQUIP:SENDER:Ｂ接触部位 = 0
	;素股
	CASE 6
		EXP:RECEIVER:精液経験 += NOWEX:SENDER:射精
		CFLAG:RECEIVER:累計精浴 += NOWEX:SENDER:射精量
		CFLAG:SENDER:累計精浴射精 += NOWEX:SENDER:射精量
		CALL POISONBODY(RECEIVER, SENDER, 6)
		STAIN:RECEIVER:Ｖ |= 4
		;接触のリセット
		TEQUIP:SENDER:Ｃ接触部位 = 0
	;足交
	CASE 7
		EXP:RECEIVER:精液経験 += NOWEX:SENDER:射精
		CFLAG:RECEIVER:累計精浴 += NOWEX:SENDER:射精量
		CFLAG:SENDER:累計精浴射精 += NOWEX:SENDER:射精量
		CALL POISONBODY(RECEIVER, SENDER, 7)
	;体表
	CASE 8
		EXP:RECEIVER:精液経験 += NOWEX:SENDER:射精 * 2
		CFLAG:RECEIVER:累計精浴 += NOWEX:SENDER:射精量
		CFLAG:SENDER:累計精浴射精 += NOWEX:SENDER:射精量
		CALL POISONBODY(RECEIVER, SENDER, 8)
ENDSELECT
SIF SHIRAHU(RECEIVER)
	CALL ADDICTION_SOURCE(RECEIVER, SENDER)
ENDIF
CFLAG:RECEIVER:积攒度 = LIMIT(CFLAG:RECEIVER:积攒度, 0, 1000)
CFLAG:SENDER:积攒度 = MAX(CFLAG:SENDER:积攒度 - NOWEX:SENDER:射精 * 50, 0)

;射精された精子を子宮内へ送る処理
@SAMEN_SHOOT3(射精した精液量, 射精した角色, 射精された角色)
#DIM 射精した精液量
#DIM 射精された角色
#DIM 減算補正値
#DIM 加算値
#DIM 射精した角色のＣ感覚

;使われてない……
#DIM 射精した角色

;73,挿入子宮口玩弄
;从后面将上書きされてるけどこれ意味有る？
IF SELECTCOM == 73
	減算補正値 = 100
ELSE
	SELECTCASE TEQUIP:射精された角色:子宮
	CASE 0
		減算補正値 = 150
	CASE 1
		減算補正値 = 120
	CASE 2
		減算補正値 = 100
ENDSELECT
ENDIF

;だいしゅきホールド
SIF TCVAR:射精された角色:Counter行動的派生 == 2 && (TCVAR:射精された角色:Counter行動 == 500 || TCVAR:射精された角色:Counter行動 == 5001)
	減算補正値 -= 30

射精した角色のＣ感覚 = ABL:射精した角色:Ｃ感覚
IF 射精した角色のＣ感覚 >= 17
	減算補正値 -= 100
ELSEIF 射精した角色のＣ感覚 >= 13
	減算補正値 -= 75
ELSEIF 射精した角色のＣ感覚 >= 9
	減算補正値 -= 50
ELSEIF 射精した角色のＣ感覚 >= 5
	減算補正値 -= 25
ENDIF

IF 減算補正値 < 0
	減算補正値 = 0
ENDIF

加算値 = 射精した精液量 - 減算補正値

IF !TALENT:射精された角色:路人
	SELECTCASE EXP:射精された角色:子宮口開発経験
		CASE IS >= 300
		CASE IS > 100
			加算値 = 加算値 * 2 / 3
		CASEELSE
			加算値 /= 2 
	ENDSELECT
ENDIF

;計算結果が負なら加算しない
IF 加算値 < 0
	RETURN 0
ENDIF
TCVAR:射精した角色:種付け量 += 加算値
EX:射精された角色:子宮内精液 += 加算値
CFLAG:射精された角色:(射精した角色+2000) += 加算値

;通常の指令外で你がＶに出した時の処理を一括でやる関数
;基本的にオナバレックス用
@ADD_SAMEN_V(ARG, 射精した精液量,無自覚)
#DIM 射精した精液量
#DIM 無自覚

射精した精液量 = MIN(BASE:MASTER:精力, 射精した精液量)
CALL SAMEN_SHOOT3(射精した精液量, MASTER, ARG)
BASE:MASTER:精力 -= 射精した精液量
EX:ARG:膣内精液 += 射精した精液量
CFLAG:ARG:累計膣内精液 += 射精した精液量
CFLAG:ARG:(MASTER+2500) += 射精した精液量
CFLAG:ARG:(MASTER+3000) += 射精した精液量

SIF !無自覚
	TCVAR:ARG:種付けられ自覚 = 1

STAIN:ARG:Ｖ |= 4
STAIN:ARG:膣内 |= 4

STAIN:MASTER:Ｐ |= 1
STAIN:MASTER:Ｐ |= 4

;通常の指令外で你がＡに出した時の処理を一括でやる関数
;基本的にオナバレックス用
@ADD_SAMEN_A(ARG, 射精した精液量)
#DIM 射精した精液量

射精した精液量 = MIN(BASE:MASTER:精力, 射精した精液量)

BASE:MASTER:精力 -= 射精した精液量
EX:ARG:肛門内精液 += 射精した精液量
CFLAG:ARG:累計肛門精液 += 射精した精液量

STAIN:ARG:Ａ |= 4
STAIN:ARG:腸内 |= 4

STAIN:MASTER:Ｐ |= 8
STAIN:MASTER:Ｐ |= 4

@ADDICTION_SOURCE(RECEIVER, SENDER)
#DIM RECEIVER
#DIM SENDER
#DIM AMOUNT
#DIMS REVISED_FLAG
#DIM REVISION
#DIM 中毒レベル


SELECTCASE TCVAR:SENDER:已射精部位FLAG
	CASE 1
		中毒レベル = ABL:RECEIVER:膣射中毒
		REVISED_FLAG = 膣内射精補正
	CASE 2
		中毒レベル = ABL:RECEIVER:肛射中毒
		REVISED_FLAG = 肛内射精補正
	CASE 4
		中毒レベル = ABL:RECEIVER:精液中毒
		REVISED_FLAG = 口内射精補正
	CASEELSE
		RETURN
ENDSELECT

TCVAR:RECEIVER:REVISED_FLAG = NOWEX:SENDER:射精量 * (10 + 中毒レベル)

IF TALENT:SENDER:濃厚精液
	REVISION = GET_REVISION(TCVAR:RECEIVER:REVISED_FLAG, 500, 1000)
ELSE
	REVISION = GET_REVISION(TCVAR:RECEIVER:REVISED_FLAG, 500, 2000)
ENDIF

;同時絶頂の場合増加
SIF SENDER == MASTER && SYNCED_ORGASM(RECEIVER)
	TIMES REVISION,1.25

SOURCE:RECEIVER:情愛 += REVISION * 2
SOURCE:RECEIVER:欲情 += REVISION * 2
SOURCE:RECEIVER:恭順 += REVISION
SOURCE:RECEIVER:屈従 += REVISION

TCVAR:RECEIVER:REVISED_FLAG = REVISION

@ADDICTION_SHOW(ARG, 補正名, 対応中毒)
#DIMS 対応中毒
#DIMS 補正名
#DIM REVISION

LOCAL = FINDELEMENT(ABLNAME, 対応中毒,,,1) ;potential bug fix

REVISION = TCVAR:ARG:補正名
SIF REVISION
	PRINTFORML %CALLNAME:ARG%（%ABL_TR(LOCAL)%{ABL:ARG:対応中毒}）：情爱＋{REVISION * 2} 情欲＋{REVISION * 2} 屈从＋{REVISION} 恭顺＋{REVISION}
IF TALENT:ARG:路人 == 1 && ABL:ARG:対応中毒 < REVISION / 150 && ABL:ARG:対応中毒 < 3
	ABL:ARG:対応中毒 ++
	CALL COLORMESSAGE(@"%CALLNAME:ARG%的%ABL_TR(LOCAL)%变成了Lv{ABL:ARG:対応中毒}",C_YELLOW,2)
ENDIF

@AUTO_SKIN_EQUIP
SIF !CFLAG:TARGET:自動ゴム
	RETURN
SIF !ITEM:避孕套
	RETURN
SIF TEQUIP:MASTER:避孕套
	RETURN

ITEM:避孕套 --
TEQUIP:MASTER:避孕套 = 1
PRINTFORML %CALLNAME:MASTER%带上了避孕套 剩余{ITEM:避孕套}个

;===========================================
;劇毒身軀の効果を規定 MASTER限定
;POINTは射精部位
;===========================================
@POISONBODY(ARG, ARG:1, POINT)
#DIM POINT
#DIM ゲージ増加
SIF !(TFLAG:劇毒身軀 && !ARG:1)
	RETURN
ゲージ増加=NOWEX:0:射精量
SELECTCASE POINT
	;膣内。黏膜吸収1.5倍。一番効果が出る
	CASE 1
		TIMES ゲージ増加,1.5
	;肛門。黏膜吸収1.0倍。
	CASE 2
	;手淫。経皮0.2倍。一応効果はある程度
	CASE 3
		TIMES ゲージ増加,0.2
	;手淫→舐め取り。黏膜0.5倍
	CASE 31
		TIMES ゲージ増加,0.5
	;口。黏膜吸収1.0倍。飲みこぼしなどで減免はしない
	CASE 4
	;胸。経皮0.5倍。手よりは多い
	CASE 5
		TIMES ゲージ増加,0.5
	;素股。黏膜？0.75倍
	CASE 6
		TIMES ゲージ増加,0.75
	;足。経皮0.2倍。一応効果はある程度
	CASE 7
		TIMES ゲージ増加,0.2
	;体表。経皮0.1倍。
	CASE 8
		TIMES ゲージ増加,0.1
ENDSELECT
;濃厚精液の場合は２倍に補正
SIF TALENT:0:濃厚精液
	ゲージ増加 *= 2
TCVAR:ARG:ポイズンゲージ += ゲージ増加
@EjBUp(ARG)
;EjectBaseUp
#DIM bID,3 =0,1,6
SIF BUp:9 == 2 && ARG
	RETURN
BASE:ARG:0=BASE:ARG:0+200,BASE:ARG:1+200
FOR LOCAL,0,3
	MAXBASE:ARG:(bID:LOCAL)+=BUp:(bID:LOCAL)
NEXT
SIF !ARG&&MAXBASE:0:TSP >= 6666
	MAXBASE:0:TSP += BUp:8