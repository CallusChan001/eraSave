;-------------------------------------------------
;聆聽天之聲
;日常系指令、レベル1
;-------------------------------------------------
@COM422
gLineCount = LINECOUNT
$INPUT_LOOP ;qol custom code, loop,  reenable stalker, and add 10-13
SIF LINECOUNT - gLineCount > 0
	CLEARLINE LINECOUNT - gLineCount
PRINTL [0] - 想找人
PRINTL [1] - 想做扫除
PRINTL [2] - 想找住在外面的人
PRINTL [3] - 排行榜
PRINTFORML [4] - 改变【追踪】对象（现在：\@ STALKED ? %CALLNAME:STALKED% # 不可用\@）
PRINTL
PRINTFORML [10] - 能力显示菜单
PRINTFORML [11] - 采集列表
;PRINTFORML [12] - 钓鱼列表
PRINTFORML [13] - 出现场所列表
PRINTL
PRINTL [100] - 返回
INPUT
IF RESULT == 0
	CALL HITOSAGASI()
	GOTO MOVE_TO
ELSEIF RESULT == 1
	CALL OHEYA_CHECK
	GOTO MOVE_TO
ELSEIF RESULT == 2
	CALL BROAD_HITOSAGASI
	TIME += 3
	RETURN 1
ELSEIF RESULT == 3
	CALL RANKING
	TIME += 3
	RETURN 1
ELSEIF RESULT == 4 ;custom code
	CALL STALKER_CHANGE
ELSEIF RESULT == 10
	CALL SHOW_CHARA_LIST("现有的角色列表", "体力气力", "「情報表示」「条件変更」")
ELSEIF RESULT == 11
	CALL SHOW_GATHERING_LIST
;ELSEIF RESULT == 12
;	CALL SHOW_FISHING_LIST
ELSEIF RESULT == 13
	CALL SHOW_APPEAR_LIST
ELSEIF RESULT == 100
	RETURN -1
ENDIF
GOTO INPUT_LOOP

$MOVE_TO ;custom code
INPUTS
RESULT = TOINT(RESULTS)
IF !ISNUMERIC(RESULTS) ;bugfix
	REPLACE RESULTS, CALLNAME:MASTER, "%CALLNAME:MASTER%"
	FOR LOCAL, MINROOM(), MAXROOM ;bugfix
		;Custom code
		SIF GET_PLACENAME(LOCAL) == RESULTS
			RESULT = LOCAL
	NEXT
ELSEIF RESULT == 0
	GOTO INPUT_LOOP
ENDIF

;IF (RESULT >= 26 && RESULT <= 35) && ABL:MASTER:教養 < 1 && !INRANGE(CFLAG:MASTER:初期位置,26,35)
;	PRINTFORMW You're too inexperienced to find it...
IF !MAP_CAN_MOVE(RESULT) ;bugfix, replace above
	CALL CANNOT_MOVE_MESSAGE(RESULT)
	GOTO MOVE_TO
ELSE
	IF IN_HOME(RESULT) == 1
		SIF AT_HOME(MASTER) == 0
			GOTO MURIDESU
		CALL SKIP_MOVE(CFLAG:MASTER:現在位置, RESULT)
	ENDIF
ENDIF

TIME += 10
RETURN 1
$MURIDESU
PRINTW 那里去不了……
;TIME += 10 bugfix(?), don't waste time for failed input
CALL HITOSAGASI
GOTO MOVE_TO

@BROAD_HITOSAGASI
PRINTFORML 广域探查
CALL COLORMESSAGE(@"可推进委托　",C_GREEN)
CALL COLORMESSAGE(@"有工作　",C_D_ORANGE)
CALL COLORMESSAGE(@"发情",C_PINK)
PRINTFORML 
DRAWLINE
$KAKUNIN
FOR LOCAL,0,MAXHOME
	SIF LOCAL == MAIN_MAP
		CONTINUE
	LOCAL:1 = 5000 + LOCAL
	PRINTFORMLC %@"[{LOCAL}] - %STR_TR(LOCAL:1)%", 41, LEFT%
	CALL 広域チェック(LOCAL,1)
	CALL QOL_WHEREABOUTS_OUTSIDE(LOCAL, 0, 50, 13) ;qol custom code
	SIF !(FLAG:画像表示 && 顔絵付きメッセージ)
		PRINTL
	PRINTL
NEXT
DRAWLINE
PRINT [100] - 确认结束
$INPUT_LOOP
INPUT
IF RESULT == 100 || RESULT == MAIN_MAP
	RETURN -1
ELSEIF RESULT < 0
	CLEARLINE 1
	GOTO INPUT_LOOP
ELSEIF RESULT >= 11
	PRINTW 尚未制作
	CLEARLINE 2
	GOTO INPUT_LOOP
ENDIF
CALL QOL_WHEREABOUTS_OUTSIDE(LOCAL, 0, 50, 13) ;qol custom code
PRINTL
CALL ASK_YN("看看其他地方","确认结束")
SIF !RESULT
	GOTO KAKUNIN

@広域チェック(ARG,ARG:1)
#DIM DYNAMIC nRoster, 200
VARSET LOCAL

LOCAL:9 = 0
FOR LOCAL,1,CHARANUM
	SIF AT_HOME(LOCAL) == 1
		CONTINUE
	SIF CFLAG:LOCAL:現在位置 == MAXROOM && CFLAG:LOCAL:睡眠
		CONTINUE
	FOR LOCAL:1,10,100,10
		IF CFLAG:LOCAL:現在位置 == ARG * 100 + LOCAL:1
			;その地域にいる角色を表示
			IF ARG:1 == 2
				;custom code
				IF FLAG:画像表示 && 顔絵付きメッセージ
					nRoster:(LOCAL:9++) = LOCAL
				ELSE
					IF QoL_IsRequestProgressable(LOCAL) ;custom code, highlight in progress requests
						SETCOLOR C_GREEN
					ELSEIF CFLAG:LOCAL:行動 ;orange work
						SETCOLOR 255, 100, 0
					ELSEIF TCVAR:LOCAL:発情 ;pink in heat
						SETCOLOR C_PINK
					ENDIF
					PRINTFORM %CALLNAME:LOCAL,15,LEFT%
					SIF ++(LOCAL:9) % 6 == 0
						PRINTL
					RESETCOLOR
				ENDIF
			ENDIF
			LOCAL:2 ++
		ENDIF
	NEXT
NEXT
SIF FLAG:画像表示 && 顔絵付きメッセージ
	CALL PRINT_ROSTER(nRoster, "broad", 50, 13, 110)
;その地域にいる人数
IF ARG:1 == 1
	IF LOCAL:2
		PRINTFORML {LOCAL:2}人
	ELSE
		PRINTL 谁也不在
	ENDIF
ENDIF


@RANKING
PRINTL [0] - 子女数量
PRINTL [1] - 累计膣内精液
PRINTL [2] - 累计肛门精液
PRINTL [3] - 累计精饮
PRINTL [4] - 累计颜射
PRINTL [5] - 高潮经验
PRINTL [6] - 喷乳经验
PRINTL [7] - 自慰经验
PRINTL [8] - 约会经验
PRINTL [9] - 接吻经验

PRINTL [100] - 返回
INPUT
IF RESULT>=0 && RESULT<10
	CALL ランキング表示(RESULT)
	RETURN -1
ELSEIF RESULT == 100
	RETURN -1
ENDIF

@ランキング表示(ARG)
#DIM RANK
#DIM ra
#DIM ranum
#DIM flagnum
#DIM kind
#DIM DYNAMIC ADDITIONAL_IN_LIST ;custom code
#DIM DYNAMIC CHARA_IMAGES_FOR_RANK, 5 ;qol custom code
#DIM DYNAMIC CHARA_IMAGE_INDEX ;qol custom code
VARSET LOCAL

;キャラ数だけLOCALの配列を准备
;すべて1に設定しておく
FOR RANK,1,CHARANUM
	;qol custom code
	IF CFLAG:RANK:出禁
		LOCAL:RANK = 100
	ELSE
	LOCAL:RANK = 1
	ENDIF
NEXT

;flagnum:フラグナンバーを管理
;kind:フラグ種類を管理（EXPかCFLAGか）
IF ARG==0
	PRINTL 子女数量
	kind = 0
	flagnum=912
ELSEIF ARG == 1
	PRINTL 累计膣内精液
	kind = 1
	flagnum=515
ELSEIF ARG == 2
	PRINTL 累计肛门精液
	kind = 1
	flagnum=516
ELSEIF ARG == 3
	PRINTL 累计精饮
	kind = 1
	flagnum=517
ELSEIF ARG == 4
	PRINTL 累计精浴
	kind = 1
	flagnum=518
ELSEIF ARG == 5
	PRINTL 高潮经验
	kind = 2
	flagnum=10
ELSEIF ARG == 6
	PRINTL 喷乳经验
	kind = 2
	flagnum=12
ELSEIF ARG == 7
	PRINTL 自慰经验
	kind = 2
	flagnum=22
ELSEIF ARG == 8
	PRINTL 约会经验
	kind = 2
	flagnum=77
ELSEIF ARG == 9
	PRINTL 亲吻经验
	kind = 2
	flagnum=27
ENDIF


;kind毎に分岐（内容はほぼ一緒）
IF kind == 0
	;他キャラと項目数の比較
	;もし負けていた場合はLOCALフラグをプラス1
	;最終的にLOCALフラグの数値が、全体の中での順位となる
	;例:LOCALフラグが1の場合、誰にも負けてない＝ランキング1位！
	;例:LOCALフラグが3の場合、二人に負けている＝ランキング3位
	FOR RANK,1,CHARANUM
		FOR ra,1,CHARANUM
			IF CFLAG:RANK:flagnum < CFLAG:ra:flagnum
				LOCAL:RANK ++
			ENDIF
		NEXT
	NEXT

	PRINTL -----------------------------------
	PRINTFORM %CALLNAME:0% 
	PRINTFORML {CFLAG:0:flagnum}个孩子
	PRINTL ------------
	
	;LOCALフラグの数値毎に表示
	;順位と名前を表示
	;同値のキャラはタイとする
	FOR ranum,1,21
		FOR RANK,1,CHARANUM
			IF LOCAL:RANK==ranum
				;項目が0の場合ランク付け終了
				IF CFLAG:(RANK):flagnum == 0
					BREAK
				ENDIF
				IF ranum <= 3
					;qol custom code
					VARSET CHARA_IMAGES_FOR_RANK
					CHARA_IMAGE_INDEX = 0
					FOR ra,1,CHARANUM
						IF LOCAL:ra == ranum && CHARA_IMAGE_INDEX < 5
							CHARA_IMAGES_FOR_RANK:(CHARA_IMAGE_INDEX++) = ra
						ENDIF
					NEXT
					CALL PRINT_ROSTER(CHARA_IMAGES_FOR_RANK, "", 100,,, 0, "笑顔")
					;CALL PRINT_FACE, RANK, "笑顔", "服", "", ""
					PRINTL
				ENDIF
				PRINTFORM 第{ranum}位  
				PRINTFORML {CFLAG:(RANK):flagnum}人
				FOR ra,1,CHARANUM
					IF LOCAL:ra == ranum
						PRINTFORM %CALLNAME:(ra)% 
					ENDIF
				NEXT
				SIF ranum == 3
					WAIT
				CALL PRINT_BREAK() ;qol custom code
				BREAK
			ENDIF
		NEXT
	NEXT
	PRINTW -----------------------------------
ELSEIF kind == 1
	FOR RANK,1,CHARANUM
		FOR ra,1,CHARANUM
			IF CFLAG:RANK:flagnum < CFLAG:ra:flagnum
				LOCAL:RANK ++
			ENDIF
		NEXT
	NEXT

	PRINTL -----------------------------------
	FOR ranum,1,21
		FOR RANK,1,CHARANUM
			IF LOCAL:RANK==ranum
				IF CFLAG:(RANK):flagnum == 0
					BREAK
				ENDIF
				PRINTFORM 第{ranum}位  
				PRINTFORML {CFLAG:(RANK):flagnum}
				IF ranum <= 3
					;qol custom code
					VARSET CHARA_IMAGES_FOR_RANK
					CHARA_IMAGE_INDEX = 0
					FOR ra,1,CHARANUM
						IF LOCAL:ra == ranum && CHARA_IMAGE_INDEX < 5
							CHARA_IMAGES_FOR_RANK:(CHARA_IMAGE_INDEX++) = ra
						ENDIF
					NEXT
					CALL PRINT_ROSTER(CHARA_IMAGES_FOR_RANK, "", 100,,, 0, "笑顔")
					;CALL PRINT_FACE, RANK, "笑顔", "服", "", ""
					PRINTL
				ENDIF
				FOR ra,1,CHARANUM
					IF LOCAL:ra == ranum
						PRINTFORM %CALLNAME:(ra)% 
					ENDIF
				NEXT
				SIF ranum == 3
					WAIT
				CALL PRINT_BREAK() ;qol custom code
				BREAK
			ENDIF
		NEXT
	NEXT
	PRINTW -----------------------------------
ELSEIF kind == 2
	FOR RANK,1,CHARANUM
		FOR ra,1,CHARANUM
			IF EXP:RANK:flagnum < EXP:ra:flagnum
				LOCAL:RANK ++
			ENDIF
		NEXT
	NEXT

	PRINTL -----------------------------------
	FOR ranum,1,21
		FOR RANK,1,CHARANUM
			IF LOCAL:RANK==ranum
				IF EXP:(RANK):flagnum == 0
					BREAK
				ENDIF
				PRINTFORM 第{ranum}位  
				PRINTFORML {EXP:(RANK):flagnum}回
				IF ranum <= 3
					;qol custom code
					VARSET CHARA_IMAGES_FOR_RANK
					CHARA_IMAGE_INDEX = 0
					FOR ra,1,CHARANUM
						IF LOCAL:ra == ranum && CHARA_IMAGE_INDEX < 5
							CHARA_IMAGES_FOR_RANK:(CHARA_IMAGE_INDEX++) = ra
						ENDIF
					NEXT
					CALL PRINT_ROSTER(CHARA_IMAGES_FOR_RANK, "", 100,,, 0, "笑顔")
					;CALL PRINT_FACE, RANK, "笑顔", "服", "", ""
					PRINTL
				ENDIF
				FOR ra,1,CHARANUM
					IF LOCAL:ra == ranum
						PRINTFORM %CALLNAME:(ra)% 
					ENDIF
				NEXT
				SIF ranum == 3
					WAIT
				CALL PRINT_BREAK() ;qol custom code
				BREAK
			ENDIF
		NEXT
	NEXT
	PRINTW -----------------------------------
ENDIF


;聆聽天之聲
@COM_ABLE422
;停止中は不可
SIF FLAG:70 == 1
	RETURN 0
;実行判定
SIF !TFLAG:100
	RETURN 0
;一括管理
SIF GLOBAL_COMABLE(421)
	RETURN RESULT
;賽銭箱
SIF !天之声可(CFLAG:MASTER:現在位置)
	RETURN 0
SIF CFLAG:诶嘿嘿 == 2
	RETURN 0
RETURN 1
