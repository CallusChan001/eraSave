;-------------------------------------------------
;推倒
;日常系指令、レベル1
;-------------------------------------------------
@COM350
#DIM NUM_TARGET
#DIM C_ID
#DIM STOPER
#DIM STOPER_TARGET,10
#DIM 时停者亲密气氛
#DIM 公开做爱检定

;推倒
NUM_TARGET = GET_TARGETNUM()
IF TFLAG:パール期限
		IF FLAG:70
		PRINTFORML 这个状态下无法进行情事
	ELSEIF TARGET == TFLAG:パール入れた人
		PRINTFORML %CALLNAME:TARGET%说着在到时间之前都先暂时保留、拒绝了%CALLNAME:MASTER%
	ELSE
		PRINTFORML 这个状态下无法进行情事
	ENDIF
	RETURN -1
ENDIF
STOPER = 时停能力者预处理()
时停者亲密气氛 = RESULT:11
公开做爱检定 = RESULT:12
;如果没有时停能力者，时停猥亵必然成功
IF FLAG:70 && !STOPER
	FOR LOCAL,1, NUM_TARGET + 1
		CFLAG:(TARGET:LOCAL):诶嘿嘿 = 1
	NEXT
ELSEIF FLAG:70 && STOPER
	;只要有时停能力者在场，时停猥亵不知情女子必然失败 ——> USERCOM @时停能力者预处理()
	;有当时停能力者在场，会回到普通推倒的判定，可以在取得所有能力者合意后推倒
	IF NUM_TARGET > 1 && 时停者亲密气氛 < 2
		TFLAG:194 = 3
		TFLAG:不让推倒 ++
	ENDIF
	IF 公开做爱检定
		CALL COLORMESSAGE(@"%CALLNAME:公开做爱检定%还是接受不了在时停下爱爱",C_AQUA,2)
		TFLAG:194 = 2
		TFLAG:不让推倒 ++
	ENDIF
	FOR LOCAL,1, NUM_TARGET + 1
		;跳过非时停者
		SIF CFLAG:(TARGET:LOCAL):344 == 0
			CONTINUE
		C_ID = TARGET:LOCAL
		;烂醉
		IF TCVAR:C_ID:烂醉 == 1
			CFLAG:C_ID:诶嘿嘿 = 1
			SIF CFLAG:C_ID:烂酔奸 < 2
				CFLAG:C_ID:烂酔奸 = 1
			IF INROOM(CFLAG:MASTER:現在位置) == 2
				CALL DATUI_SHOES(LOCAL,0)
				CALL DATUI_SHOES(MASTER,0)
			ENDIF
		;合意未取得
		ELSEIF !GETBIT(CFLAG:C_ID:既成事實 , 1) && !TALENT:C_ID:合意誤認
			;未取得だと多人数は駄目
			IF NUM_TARGET > 1
				TFLAG:194 = 3
				TFLAG:不让推倒 ++
				BREAK
			;口上側による制御
			ELSEIF CFLAG:C_ID:口上内抱き寄せ判定_初回
				CALL KOJO_MESSAGE_SEND("PERMISSION", 1, C_ID)
				SELECTCASE RESULT
					CASE -1
						TCVAR:C_ID:初次拥抱 = 98
						TFLAG:不让推倒 ++
						BREAK
					CASE 0
						CALL 抱き寄せ(C_ID)
					CASE 1
						TCVAR:C_ID:初次拥抱 = 99
						SETBIT CFLAG:C_ID:既成事實 , 1
						CALL COLORMESSAGE(@"获得了和%CALLNAME:C_ID%的合意",C_YELLOW,2)
				ENDSELECT
			ELSE
				CALL 抱き寄せ(C_ID)
			ENDIF
		;合意取得済み
		ELSE
			IF FLAG:守矢神簽约会的对象 == C_ID || TALENT:C_ID:風騷 || CFLAG:C_ID:诶嘿嘿 || FLAG:催眠強度 > 75
				GOTO OK
			ELSEIF (BASE:C_ID:情緒 < 300 || 时停者亲密气氛 < 2)
				TFLAG:194 = 4
				TFLAG:不让推倒 ++
			;口上側による制御
			ELSEIF CFLAG:C_ID:口上内抱き寄せ判定_通常
				CALL KOJO_MESSAGE_SEND("PERMISSION", 2, C_ID)
				IF RESULT == -1
					TFLAG:194 = 100
					TFLAG:不让推倒 ++
				ELSE
					GOTO OK1
				ENDIF
			ELSE
				$OK1
				SIF BASE:C_ID:情緒 < 300
					BASE:C_ID:情緒 = 300
				CFLAG:C_ID:诶嘿嘿 = 1
				IF INROOM(CFLAG:MASTER:現在位置) == 2
					CALL DATUI_SHOES(LOCAL,0)
					CALL DATUI_SHOES(MASTER,0)
				ENDIF
			ENDIF
		ENDIF
	NEXT
	;标志处理放这里，依附于潜伏系统，算是取巧了
	IF !TFLAG:不让推倒
		SETBIT FLAG:99,3
		SETBIT CFLAG:TARGET:526,0
	ENDIF
;潜伏中（时停中人前做爱也一样）可以直接夺回主导，隔离周围人干扰判断
ELSEIF FLAG:99 && GETBIT(CFLAG:TARGET:526,0) && TFLAG:102 == 3
	SIF BASE:TARGET:情緒 < 300
		BASE:TARGET:情緒 = 300
	CFLAG:TARGET:诶嘿嘿 = 1
	CFLAG:MASTER:诶嘿嘿 = 1
	TFLAG:102 = 2
	RETURN 1
ELSE
	;视线による中断判定
	IF EYEWITNESS() == 1
		TFLAG:194 = 1
		TFLAG:不让推倒 ++
	ENDIF
	;MASTER的に多人数は無理だった
	IF NUM_TARGET > 1 && TCVAR:MASTER:亲热 < 2
		TFLAG:194 = 3
		TFLAG:不让推倒 ++
	ENDIF
	
	FOR LOCAL,1, NUM_TARGET + 1
		C_ID = TARGET:LOCAL
		;烂醉
		IF TCVAR:C_ID:烂醉 == 1
			CFLAG:C_ID:诶嘿嘿 = 1
			SIF CFLAG:C_ID:烂酔奸 < 2
				CFLAG:C_ID:烂酔奸 = 1
			IF INROOM(CFLAG:MASTER:現在位置) == 2
				CALL DATUI_SHOES(LOCAL,0)
				CALL DATUI_SHOES(MASTER,0)
			ENDIF
		;合意未取得
		ELSEIF !GETBIT(CFLAG:C_ID:既成事實 , 1) && !TALENT:C_ID:合意誤認
			;未取得だと多人数は駄目
			IF NUM_TARGET > 1
				TFLAG:194 = 3
				TFLAG:不让推倒 ++
				BREAK
			;口上側による制御
			ELSEIF CFLAG:C_ID:口上内抱き寄せ判定_初回
				CALL KOJO_MESSAGE_SEND("PERMISSION", 1, C_ID)
				SELECTCASE RESULT
					CASE -1
						TCVAR:C_ID:初次拥抱 = 98
						TFLAG:不让推倒 ++
						BREAK
					CASE 0
						CALL 抱き寄せ(C_ID)
					CASE 1
						TCVAR:C_ID:初次拥抱 = 99
						SETBIT CFLAG:C_ID:既成事實 , 1
						CALL COLORMESSAGE(@"获得了和%CALLNAME:C_ID%的合意",C_YELLOW,2)
				ENDSELECT
			ELSE
				CALL 抱き寄せ(C_ID)
			ENDIF
		;合意取得済み
		ELSE
			IF FLAG:守矢神簽约会的对象 == C_ID || TALENT:C_ID:風騷 || CFLAG:C_ID:诶嘿嘿 || FLAG:催眠強度 > 75
				GOTO OK
			ELSEIF (BASE:C_ID:情緒 < 300 || TCVAR:MASTER:亲热 < 2)
				TFLAG:194 = 4
				TFLAG:不让推倒 ++
			;口上側による制御
			ELSEIF CFLAG:C_ID:口上内抱き寄せ判定_通常
				CALL KOJO_MESSAGE_SEND("PERMISSION", 2, C_ID)
				IF RESULT == -1
					TFLAG:194 = 100
					TFLAG:不让推倒 ++
				ELSE
					GOTO OK
				ENDIF
			ELSE
				$OK
				SIF BASE:C_ID:情緒 < 300
					BASE:C_ID:情緒 = 300
				CFLAG:C_ID:诶嘿嘿 = 1
				IF INROOM(CFLAG:MASTER:現在位置) == 2
					CALL DATUI_SHOES(LOCAL,0)
					CALL DATUI_SHOES(MASTER,0)
				ENDIF
			ENDIF
		ENDIF
	NEXT
ENDIF

IF TFLAG:不让推倒
	FOR LOCAL,1, NUM_TARGET + 1
		CALL ENDUFUFU(TARGET:LOCAL)
	NEXT
	DOWNBASE:MASTER:気力 = 50
	BASE:TARGET:情緒 /= 2
	TFLAG:102 = 0
	;不让推倒时在这里结束，不进行诶嘿嘿记录
	RETURN 1
ELSE
	;攻守交代
	;ELSEIF CFLAG:MASTER:诶嘿嘿 == 1 && !FLAG:70
	;	FOR LOCAL,0,CHARANUM
	;		CFLAG:(TARGET:LOCAL):诶嘿嘿 == 2 
	;	NEXT
	;	TIME += 1
	;	RETURN 1
	IF !FLAG:70
		FOR LOCAL,1, NUM_TARGET + 1
			CALL UWAKI_RECORD(TARGET:LOCAL, 1)
		NEXT
	ENDIF
	CFLAG:MASTER:诶嘿嘿 = 1
	TFLAG:COMABLE管理 = 2
	SIF !FLAG:70
		TIME += 1
ENDIF
;情景文本用记录处理
IF !UFUFU_START_TIME
	UFUFU_START_TIME = TIME
	UFUFU_START_DAY = DAY
ENDIF
SIF CFLAG:MASTER:現在位置 == CFLAG:MASTER:初期位置
	CALL 诶嘿嘿记录
SIF GROUPMATCH(TCVAR:抱き寄せ初回, 6, 7, 8) ;in case of rejection, send the appropriate flag so it shows first no matter if it's in public etc
	TFLAG:194 = 0
RETURN !GROUPMATCH(TCVAR:抱き寄せ初回, 6, 7, 8) && TFLAG:押し倒せない ? 0 # 1 ;cancel favor gain when unsuccessful


;在情侣酒店情人旅馆以外的约会地点“诶嘿嘿”的特殊条件
@特殊诶嘿嘿条件(ARG)
#FUNCTION
SIF ARG == 67 && TCVAR:ARG:特殊事件 >= 4 && CFLAG:ARG:行動 != 5 && (GETBIT(CFLAG:ARG:既成事實 , 1) || TALENT:ARG:合意誤認) && TCVAR:ARG:亲热 >= 2 && CFLAG:ARG:現在位置 == 寺子屋 && GET_TARGETNUM() < 2
	RETURNF 1
SIF TCVAR:ARG:特殊事件
	RETURNF 1
RETURNF 0

@时停能力者预处理
#FUNCTION
#DIM STOPER
#DIM STOPER_TARGET,10
#DIM 时停者亲密气氛
#DIM 公开做爱检定
#DIM NUM_TARGET
VARSET RESULT,0,1,13
NUM_TARGET = GET_TARGETNUM()
SIF NUM_TARGET == 0
	RETURNF 0
STOPER = 0
时停者亲密气氛 = TCVAR:TARGET:亲热
公开做爱检定 = 0
FOR LOCAL,1, NUM_TARGET + 1
	IF CFLAG:(TARGET:LOCAL):344 == 1
		STOPER ++
		;获得时停者同伴之间的亲热气氛，代替TCVAR:MASTER:亲热的判断
		时停者亲密气氛 = MIN(TCVAR:(TARGET:LOCAL):亲热 , 时停者亲密气氛)
		;时停下合意做爱暂时套用邀请到阴暗处的判定，否决时随意一个对象就好
		IF !TALENT:(TARGET:LOCAL):無知 && ABL:(TARGET:LOCAL):露出癖 + TALENT:(TARGET:LOCAL):羞恥心 < 3
			公开做爱检定 = TARGET:LOCAL
		ENDIF
		;取得前十个时停者的编号，供描述使用。我觉得够用了
		SIF LOCAL < 11
			RESULT:(LOCAL) = TARGET:LOCAL
	ENDIF
NEXT
RESULT:11 = 时停者亲密气氛
RESULT:12 = 公开做爱检定
RETURNF STOPER


;-------------------------------------------------
;実行判定
;-------------------------------------------------
@COM_ABLE350
#DIM NUM_TARGET
;妄想なので全通し
SIF TFLAG:妄想中 == 1 && CFLAG:诶嘿嘿 != 1
	RETURN 1
;推倒実行判定
SIF !TFLAG:100
	RETURN 0
;一括管理
SIF GLOBAL_COMABLE(350)
	RETURN RESULT
;时间停止中以及潜伏诶嘿嘿时跳过
IF (!FLAG:70 || CFLAG:344 == 1) && !GETBIT(CFLAG:526,0)
	;多人数
	NUM_TARGET = GET_TARGETNUM()
	SELECTCASE NUM_TARGET
	CASE 0
		RETURN 0
	CASE 1
	CASEELSE
		;新增逆推下获得主导检测，跳过非诶嘿嘿状态角色检测，为潜伏模式等同时存在诶嘿嘿状态和非诶嘿嘿状态的角色的复杂情况准备
		IF TFLAG:102 == 3
			FOR LOCAL,1, NUM_TARGET + 1
				SIF CFLAG:(TARGET:LOCAL):诶嘿嘿 == 0
					CONTINUE
				SIF !GETBIT(CFLAG:(TARGET:LOCAL):既成事實 , 1) && !TALENT:(TARGET:LOCAL):合意誤認
					RETURN 0
				;寝てる角色が居るとダメ
				SIF CFLAG:(TARGET:LOCAL):睡眠
					RETURN 0
				;酔ってる角色がいると駄目
				SIF TCVAR:(TARGET:LOCAL):烂醉
					RETURN 0
			NEXT
		ELSE
			FOR LOCAL, 1, NUM_TARGET + 1
				;全角色に合意がないとダメ
				SIF !GETBIT(CFLAG:(TARGET:LOCAL):既成事實 , 1) && !TALENT:(TARGET:LOCAL):合意誤認
					RETURN 0
				;寝てる角色が居るとダメ
				SIF CFLAG:(TARGET:LOCAL):睡眠
					RETURN 0
				;酔ってる角色がいると駄目
				SIF TCVAR:(TARGET:LOCAL):烂醉
					RETURN 0
			NEXT
		ENDIF
	ENDSELECT
	SIF TFLAG:接吻マーク && TFLAG:接吻マーク != TARGET
		RETURN 0
	;睡眠中
	SIF CFLAG:睡眠
		RETURN 0
	;陪睡中
	SIF CFLAG:陪睡中
		RETURN 0
	;仕事中
	IF JOBFUCKING == 0
		SIF CFLAG:行動 == 5 && !TCVAR:TARGET:烂醉
			RETURN 0
	ENDIF
	SIF GETBIT(TCVAR:随便,0)
		RETURN 0
	;约会中
	SIF (CHK_DATENOW(CFLAG:MASTER:约会中) && CFLAG:現在位置 != 情人用宿屋 && CFLAG:現在位置 != 情人旅館 && CFLAG:現在位置 != OMANEKIBEYA()) && !特殊诶嘿嘿条件(TARGET)
		RETURN 0
	;SIF MONEY < 3000 && (CFLAG:現在位置 == 情人用宿屋 || CFLAG:現在位置 == 情人旅館)
		;RETURN 0
ENDIF
;気力0
SIF BASE:MASTER:気力 <= 0
	RETURN 0
;甲斐性無しにそんな度胸はない
SIF FLAG:甲斐性無
	RETURN 0
RETURN 1

;人目があるかどうか返す式中関数
;見てる角色がいると1､路人だと2
@EYEWITNESS()
#FUNCTION
FOR LOCAL, 1, CHARANUM
	SIF CFLAG:LOCAL:現在位置 == CFLAG:MASTER:現在位置
		CONTINUE
	SIF CAN_MOVE(CFLAG:LOCAL:現在位置, CFLAG:MASTER:現在位置) & 2
		RETURNF 1
NEXT
SIF WITH_MOB()
	RETURNF 2
SIF DATE_HITOGOMI()
	RETURNF 2

RETURNF 0
