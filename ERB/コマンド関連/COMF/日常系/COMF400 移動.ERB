;-------------------------------------------------
;移動
;日常系指令、レベル1
;-------------------------------------------------
@COM400
#DIM 入浴拒否
#DIM 虫かご
#DIM 忍び込み
#DIM 停下脚步対象
#DIM BUTTON返回
#DIM BUTTON切替左
#DIM BUTTON切替中
#DIM BUTTON切替右
#DIM 进不去
#DIM ANIMATION_SEED
#DIM PREV_REDRAW
;#DIM DYNAMIC CAN_BE_UNLOKED_ROOM_SAVE
;SIF GMF_GETBIT("幻想乡大地图")
	;JUMP GMF_COM400

BUTTON返回 = MAXROOM + 1
BUTTON切替左 = MAXROOM + 2
BUTTON切替中 = MAXROOM + 4
BUTTON切替右 = MAXROOM + 4
进不去 = 0
ANIMATION_SEED = 0
PREV_REDRAW = CURRENTREDRAW()

;Map Animation Code
$MAPANIMATION
LINESTART = LINECOUNT
SIF ANIMATERECOLOREDMAPS && !FLAG:70
	ANIMATION_SEED ++

;人数カウントをリセット
VARSET COUNTCHARA
;部屋の人数カウントを設定
FOR LOCAL, 1, CHARANUM
	COUNTCHARA:(CFLAG:LOCAL:現在位置) ++
NEXT
入浴拒否 = 0
CALL TURN_RESET

DRAWLINE
;
;	// 自宅マップの表示を新描画方式に
;
IF RECOLOREDMAPS
	CALL DRAW_COLOREDMAP(ANIMATION_SEED)
ELSE
	CALL DRAW_MAP
ENDIF
;qol custom code, prints destination
;012应该是一组，345是一组
;IF FLAG:移動先表示 < 4
IF FLAG:移動先表示 < 3
	PRINTL
	TRYCALLFORM MAP_{MAIN_MAP}_{TFLAG:マップ切り替え}
ENDIF
PRINTL

PRINTFORML 当前位置→[{(CFLAG:MASTER:現在位置)}]%NAME_FROM_PLACE(CFLAG:MASTER:現在位置)%

IF FLAG:察知模式 == 1
	PRINT 颜色的说明：
	CALL COLORMESSAGE("逗留中　", C_H_PINK, 0)
	CALL COLORMESSAGE("工作中　", C_D_ORANGE, 0)
	CALL COLORMESSAGE("睡眠中　", C_N_BLUE, 0)
	CALL COLORMESSAGE("路人　", C_D_PINK, 0)
	CALL COLORMESSAGE("自由行动", C_YELLOW, 0)
	PRINTL
ELSEIF FLAG:察知模式 == 2
	IF OUTROOF(CFLAG:MASTER:現在位置) && DAY:2 == 4
		PRINT 积雪量：
		CALL COLORMESSAGE("干净　", C_GREEN, 0)
		CALL COLORMESSAGE("小　", C_M_GREEN , 0)
		CALL COLORMESSAGE("较小　", C_P_GREEN, 0)
		CALL COLORMESSAGE("中　", 0xFFFFFF, 0)
		CALL COLORMESSAGE("较大　", 0xFFFFFF, 0)
		CALL COLORMESSAGE("大　", 0xFFFFFF , 0)
		CALL COLORMESSAGE("雪山", 0xFFFFFF, 0)
		PRINTL
	ELSE
		PRINT 清洁度：
		CALL COLORMESSAGE("最高　", C_GREEN, 0)
		CALL COLORMESSAGE("高　", C_M_GREEN , 0)
		CALL COLORMESSAGE("较高　", C_P_GREEN, 0)
		CALL COLORMESSAGE("中　", C_YELLOW, 0)
		CALL COLORMESSAGE("较低　", C_V_PINK, 0)
		CALL COLORMESSAGE("低　", C_RED , 0)
		CALL COLORMESSAGE("垃圾山", C_RED, 0)
		PRINTL
	ENDIF
ENDIF
SIF CFLAG:MASTER:現在位置 != CFLAG:MASTER:初期位置
	PRINTL [  0] - 返回私室
FOR LOCAL, MINROOM(), MAXROOM
	SIF !(CAN_MOVE(CFLAG:MASTER:現在位置, LOCAL) & 1)
		CONTINUE
	SIF NAME_FROM_PLACE(LOCAL) == ""
		CONTINUE
	SELECTCASE FLAG:移動先表示
		CASE 1, 3
			PRINTFORML [{LOCAL, 3}] - %NAME_FROM_PLACE(LOCAL)%
		CASE 2, 4
			PRINTFORM [{LOCAL, 3}] - %NAME_FROM_PLACE(LOCAL),5,LEFT%
		CASE 0, 5
	ENDSELECT
NEXT
;qol custom code, add extra line after printing rows
SIF FLAG:移動先表示 == 2 || FLAG:移動先表示 == 4
	PRINTL
IF !CAN_MOVE(CFLAG:MASTER:現在位置, ENTRANCE) & 1 && CFLAG:MASTER:現在位置 != ENTRANCE
	SIF FLAG:移動先表示 == 1
		PRINTL
	PRINTFORML [{ENTRANCE, 3}] - %NAME_FROM_PLACE(ENTRANCE)%
ELSEIF FLAG:移動先表示 == 1
	PRINTL
ENDIF
PRINTFORM [{BUTTON返回, 3}] - 返回　　　
PRINTBUTTON "＜]", BUTTON切替左
PRINTBUTTON "地图切换", BUTTON切替中
PRINTFORM ({TFLAG:地圖切換})
PRINTBUTTON "[＞", BUTTON切替右
SIF TALENT:MASTER:居場所察知 || TALENT:MASTER:汚部屋察知
	PRINTBUTTON "　　[Y] - 察觉模式", "Y"
IF FLAG:察知模式 == 1
	PRINT (居)　
ELSEIF FLAG:察知模式 == 2
	PRINT (污)　
ELSE
	PRINT 　　
ENDIF
SIF TALENT:MASTER:居場所察知 && FLAG:察知模式 == 1
	PRINTBUTTON "[Z] - 所在地察觉　 ", "Z"
SIF TALENT:MASTER:汚部屋察知 && FLAG:察知模式 == 2
	PRINTBUTTON "[X] - 脏房间察觉　 ", "X"
PRINTBUTTON "[C] - 切换目的地显示", "C"
IF TALENT:MASTER:体型 < -4 ;&& !CFLAG:MASTER:同行
	IF CFLAG:MASTER:同行
		PRINTL
		PRINT （搭顺风车真开心）
	ELSE
		PRINTL
		PRINT （走过去都很辛苦…）
	ENDIF
ENDIF

DO
	;Map Animation Code
	TOOLTIP_SETDELAY 100
	IF ANIMATERECOLOREDMAPS && !FLAG:70
		REDRAW PREV_REDRAW
		TINPUTS ANIMATERECOLOREDMAPS,"UPDATE",0,""
	ELSE
		INPUTS
	ENDIF
	TOOLTIP_SETDELAY 500
	;システム系を先に処理
	SELECTCASE RESULTS
	CASE "UPDATE"
		PREV_REDRAW = CURRENTREDRAW()
		REDRAW 0
		CLEARLINE LINECOUNT - LINESTART
		BREAK
	;察知系
	CASE "Z", "z", "X", "x"
		IF TALENT:MASTER:居場所察知 && (RESULTS == "Z" || RESULTS == "z")
			CALL HITOSAGASI(,1) ;qol custom code
		ELSEIF TALENT:MASTER:汚部屋察知 && (RESULTS == "X" || RESULTS == "x")
			CALL OHEYA_CHECK
		ENDIF
		$INPUT_LOOP
		INPUT
		IF RESULT == 0
			RESTART
		ELSEIF RESULT == -1 && (RESULTS == "Z" || RESULTS == "z") ;qol custom code
			CALL BROAD_HITOSAGASI
			RESTART
		;-----------------------------------
		;移動範囲外
		ELSEIF IN_HOME(RESULT) != 1 || GET_MAPID(CFLAG:MASTER:現在位置) != MAIN_MAP
			TFLAG:地圖切換 = 0
			PRINTW 移动范围外
			RETURN -1
		ELSEIF MAP_CAN_MOVE(RESULT) == 0
			IF TFLAG:移動不能メッセージ == 999 && LOCKPICK_SYSTEM > 0
				;qol 开锁部分被移动到了开锁系统中，原函数好像只要进开锁都是return，除非找不到门，这里简化处理都return吧
				CALL LOCKPICK_INFO(RESULT)
				RETURN
			ELSE
				CALL CANNOT_MOVE_MESSAGE(RESULT)
				GOTO INPUT_LOOP
			ENDIF
		ELSEIF IN_HOME(RESULT) == 1
			CALL SKIP_MOVE(CFLAG:MASTER:現在位置, RESULT)
			RETURN
		ENDIF
	;察知切り替え
	CASE "Y", "y"
		IF TALENT:MASTER:居場所察知 && TALENT:MASTER:汚部屋察知
			FLAG:察知模式 += 1
			SIF FLAG:察知模式 >= 3
				FLAG:察知模式 = 0
		ELSEIF TALENT:MASTER:居場所察知
			FLAG:察知模式 = !FLAG:察知模式
		ELSEIF TALENT:MASTER:汚部屋察知
			FLAG:察知模式 = (!FLAG:察知模式) * 2
		ENDIF
		RESTART
	;表示切り替え
	CASE "C", "c"
		FLAG:移動先表示 += 1
		;Qol custom code, more options
		SIF FLAG:移動先表示 > 5
			FLAG:移動先表示 = 0
		RESTART
	CASE ""
		CONTINUE
	ENDSELECT

	;半角数字の場合のみ判定を続行
	IF ISNUMERIC(RESULTS)
		RESULT = TOINT(RESULTS)
	ELSE
		CALL CANNOT_MOVE_MESSAGE(0)
		CONTINUE
	ENDIF
	;システム系を先に処理
	SELECTCASE RESULT
	CASE BUTTON返回, CFLAG:MASTER:現在位置
		RETURN -1
	CASE BUTTON切替左
		TFLAG:地圖切換 -= 1
		SIF TFLAG:地圖切換 <= 0
			TFLAG:地圖切換 = MAP_PAGES
		RESTART
	CASE BUTTON切替右
		TFLAG:地圖切換 += 1
		SIF TFLAG:地圖切換 > MAP_PAGES
			TFLAG:地圖切換 = 1
		RESTART
	;私室に返回
	CASE 0
		IF IN_HOME(CFLAG:MASTER:初期位置) != 1
			PRINTW 初始位置不正确，重设为私室位置
			CFLAG:MASTER:初期位置 = 默认初期位置
		ENDIF
		SIF CFLAG:MASTER:現在位置 != CFLAG:MASTER:初期位置
			CALL SKIP_MOVE(CFLAG:MASTER:現在位置, CFLAG:MASTER:初期位置)
		RETURN
	ENDSELECT

	;残るは通常の場所の選択もしくは誤入力

	;TWの方針として非推奨なんだけど手打ち入力でこれがあると入力文字数減って便利なんだ
	SIF INRANGE(RESULT, 1, 99)
		RESULT += MAIN_MAP * 100
	;同じ場所は中止
	IF RESULT == CFLAG:MASTER:現在位置
		RETURN -1
	;移動範囲外 bug fix re-added to prevent crashes and walking into void
	ELSEIF IN_HOME(RESULT) != 1
		TFLAG:マップ切り替え = 0
		PRINTW 移动范围外
		CONTINUE
	;-----------------------------
	;移動不可能なら弾くよ
	ELSEIF MAP_CAN_MOVE(RESULT) == 0
		IF TFLAG:移動不能メッセージ == 999 && LOCKPICK_SYSTEM > 0
			;qol 开锁部分被移动到了开锁系统中
			CALL LOCKPICK_INFO(RESULT)
			RETURN
		ELSE
			CALL CANNOT_MOVE_MESSAGE(RESULT)
			CONTINUE
		ENDIF
	;移動する
	ELSE
		CALL SKIP_MOVE(CFLAG:MASTER:現在位置, RESULT)
		RETURN
	ENDIF
LOOP 1
;Map Animation Code
SIF ANIMATERECOLOREDMAPS && !FLAG:時間停止
	GOTO MAPANIMATION

;移動
@COM_ABLE400
;移動実行判定
SIF !TFLAG:100
	RETURN 0
;一括管理
SIF GLOBAL_COMABLE(400)
	RETURN RESULT
SIF CFLAG:诶嘿嘿
	RETURN 0
SIF CFLAG:MASTER:恶作剧
	RETURN 0
SIF CFLAG:MASTER:陪睡中
	RETURN 0
;现在全地图可以移动
SIF !GMF_GETBIT("幻想乡大地图") && AT_HOME(MASTER) == 0
	RETURN 0
RETURN 1

@SKIP_MOVE(ARG, 最終目的地)
#LOCALSIZE 5
#LOCALSSIZE 1
#DIM 暫定目的地,10
#DIM 暫定目的地決定回数
#DIM 最終目的地
#DIM 直前位置
#DIM 出発地点
#DIM 経過時間
#DIM 中継地点,20
#DIM 中継回数
#DIM RELAY_COUNT
#DIM 直前の目的地
#DIM TSP消費倍率

;ARG:0	出発位置
;ARG:1	最終目的地
VARSET LOCAL
VARSET 中継地点
暫定目的地 = 最終目的地
経過時間 = 0
中継回数 = 0
TFLAG:地圖切換 = 0

出発地点 = CFLAG:MASTER:現在位置
FLAG:自室施錠 = 0
;自動掃除
SIF GETBIT(FLAG:自動掃除, 1)
	CALL AUTO_SWEEP

;补丁的内容现在单独分离出来
SIF SWEEPGOD && GETBIT(FLAG:自動掃除, 1)
	CALL SWEEPGOD_AUTO_SWEEP_SKIP_MOVE

IF (CAN_MOVE(CFLAG:MASTER:現在位置, 暫定目的地) & 1)
	直前位置 = ARG
	経過時間 = 1
	CFLAG:MASTER:現在位置 = 最終目的地
	RESULT = 最終目的地
	GOTO STOP
ELSE
	TRYCALLFORM SKIP_MOVE_{MAIN_MAP}(最終目的地)
ENDIF

出発地点 = CFLAG:MASTER:現在位置
直前の目的地 = -1

FOR 中継回数,0,最大寻路深度
	WHILE !(CAN_MOVE(出発地点, 暫定目的地) & 1)
		;TRYCALLFORM SKIP_MOVE_{MAIN_MAP}(暫定目的地,出発地点)
		TRYCALLFORM QOL_SKIP_MOVE_INFO(暫定目的地,出発地点,MAIN_MAP)
		[IF_DEBUG]
		PRINTFORML 因为不能直接去{暫定目的地}%STR:(8000 + 暫定目的地)%所以以{RESULT}%STR:(8000 + RESULT)%为目标
		[ENDIF]
		SIF 直前の目的地 == RESULT
			THROW 产生无限循环。
		直前の目的地 = 暫定目的地
		暫定目的地 = RESULT
	WEND
	[IF_DEBUG]
	SETCOLOR C_YELLOW
	PRINTFORML 将第{中継回数+1}个暂定目的地决定为%NAME_FROM_PLACE(暫定目的地)%
	RESETCOLOR
	[ENDIF]
	直前の目的地 = -1
	経過時間 += 1
	中継地点:中継回数 = 暫定目的地
	SIF CAN_MOVE(暫定目的地,最終目的地) & 1
		BREAK
	出発地点 = 暫定目的地
	暫定目的地 = 最終目的地
NEXT
直前位置 = 暫定目的地

FOR RELAY_COUNT,1,中継回数 + 1
	LOCAL:3 = 0
	FOR LOCAL,1,CHARANUM
		IF CFLAG:LOCAL:現在位置 == 中継地点:(RELAY_COUNT-1)
			LOCAL:3 = LOCAL
			BREAK
		ENDIF
	NEXT
	;#;PRINTFORM 第{RELAY_COUNT}中继点%NAME_FROM_PLACE(中継地点:(RELAY_COUNT-1))% - 
	IF LOCAL:3
		CALL KOJO_ACTIVE_INFO(LOCAL:3)
		PRINTFORML 经过%NAME_FROM_PLACE(中継地点:(RELAY_COUNT-1))%时遇上了%CALLNAME:(LOCAL:3)%
		IF FLAG:停下脚步 == 2
			;立ち止まらない
		ELSEIF FLAG:停下脚步 == 1 && !RESULT
			;口上がある場合のみ
		ELSE
			CALL ASK_M("打声招呼后继续移动",!FLAG:70,"无视",1,"停下来",1)
			IF RESULT == 2
				CALL KOJO_MESSAGE_SEND("EVENT",4,LOCAL:3,1,0)
				経過時間 = RELAY_COUNT
				CFLAG:MASTER:現在位置 = 中継地点:(RELAY_COUNT - 1)
				RESULT = 中継地点:RELAY_COUNT
				GOTO STOP
			ELSEIF RESULT == 1
				CALL KOJO_MESSAGE_SEND("EVENT",4,LOCAL:3,3,0)
			ELSE
				CALL KOJO_MESSAGE_SEND("EVENT",4,LOCAL:3,2,0)
			ENDIF
		ENDIF
	ELSE
		PRINTFORML 谁也不在
	ENDIF
NEXT

経過時間 = 中継回数 + 1
CFLAG:MASTER:現在位置 = 最終目的地
RESULT = 最終目的地

$STOP
IF IN_TOILET(RESULT)
	CALL 廁所侵入(RESULT)
	SIF RESULT == -1
		CFLAG:MASTER:現在位置 = 直前位置
ELSEIF BATHCHECK(RESULT)
	LOCAL:1 = IN_ROOM_MEMBER("MIN", RESULT, "CFLAG", 6)
	IF !LOCAL:1 && !CFLAG:MASTER:同行
		PRINTFORMW 进入浴场的%CALLNAME:MASTER%泡在了浴池里
	ELSEIF LOCAL:1 && 風呂逐出条件(LOCAL:1) && !CFLAG:MASTER:同行
		PRINTFORMW 被在浴场里的%CALLNAME:(LOCAL:1)%赶出来了…
		CALL KOJO_MESSAGE_SEND("EVENT",11,LOCAL:1,1,0)
		CFLAG:MASTER:現在位置 = 直前位置
	ELSEIF LOCAL:1 && !CFLAG:MASTER:同行
		IF FLAG:70 == 1
			PRINTFORMW %CALLNAME:(LOCAL:1)%在入浴中的样子…
		ELSE
			PRINTFORMW 与在浴场里的%CALLNAME:(LOCAL:1)%对上了视线…
			CALL KOJO_MESSAGE_SEND("EVENT",11,LOCAL:1,2,0)
		ENDIF
		CFLAG:MASTER:現在位置 = 最終目的地
	ELSE
		FOR LOCAL, 1, CHARANUM
			IF 風呂逐出条件(LOCAL) && CFLAG:LOCAL:同行
				PRINTFORMW 共同入浴的邀请被%CALLNAME:LOCAL%拒绝了
				CALL KOJO_MESSAGE_SEND("EVENT",23,LOCAL,1,0)
				CFLAG:MASTER:現在位置 = 直前位置
				GOTO END
			ELSEIF LOCAL:1 && 風呂逐出条件(LOCAL:1)
				PRINTFORMW 被在浴场里的%CALLNAME:(LOCAL:1)%赶出来了…
				CALL KOJO_MESSAGE_SEND("EVENT",11,LOCAL:1,1,0)
				CFLAG:MASTER:現在位置 = 直前位置
				GOTO END
			ENDIF
		NEXT
		FOR LOCAL, 1, CHARANUM
			IF CFLAG:LOCAL:同行
				PRINTFORMW %CALLNAME:LOCAL%好像想一起进入浴场的样子
				CALL KOJO_MESSAGE_SEND("EVENT",23,LOCAL,2,0)
				BREAK
			ENDIF
		NEXT
		CFLAG:MASTER:現在位置 = 最終目的地
	ENDIF
ELSEIF RESULT == 54
	CALL 虫かご侵入(RESULT)
	SIF RESULT == -1
		CFLAG:MASTER:現在位置 = 直前位置
;原函数针对可以进入原本锁住的房间，默认家主在屋内睡觉一种对应情况，不管家主实际上在不在家
;默认将玩家视为闯入，仅在MASTER搬入该地点才不会被视为闯入
ELSEIF LOCK:(RESULT)
	LOCAL:2 = 0
	LOCAL:4 = RESULT
	IF FLAG:70 == 1
		FOR LOCAL, 1, CHARANUM
			IF CFLAG:LOCAL:311 == RESULT && CFLAG:LOCAL:睡眠 && !CFLAG:LOCAL:出禁
				PRINTFORMW 好像%CALLNAME:LOCAL%正在睡觉的样子
				LOCAL:2 = 1
			ENDIF
		NEXT
	ELSEIF FLAG:70 == 0
		FOR LOCAL, 1, CHARANUM
			IF CFLAG:LOCAL:311 == RESULT && CFLAG:LOCAL:睡眠 && !CFLAG:LOCAL:出禁
				PRINTFORMW 好像%CALLNAME:LOCAL%正在睡觉的样子
				LOCAL:2 = 1
			;ELSEIF CFLAG:LOCAL:311 == RESULT && !CFLAG:LOCAL:睡眠 && !CFLAG:LOCAL:出禁
			;这里应该是已经进入睡眠时间但仍能互动的一段时间
			ELSEIF CFLAG:LOCAL:311 == RESULT && CFLAG:LOCAL:300 == RESULT && 睡眠時間(LOCAL) && !CFLAG:LOCAL:出禁
				PRINTFORML 好像%CALLNAME:LOCAL%正准备睡觉了
				PRINTFORMW 还能听到一些动静…
				LOCAL:2 = 1
			ENDIF
		NEXT
		;从排除非潜入情况的白名单改为只有上述三种情况才算潜入的黑名单
		IF !LOCAL:2
		;移動成立
		CFLAG:MASTER:現在位置 = 最終目的地
		ELSE
			CALL ASK_YN("潜入房间","算了吧")
			IF RESULT == 0
				CALL 潜入房間(LOCAL:4, 直前位置)
				GOTO END
			ELSEIF RESULT == 1
				CFLAG:MASTER:現在位置 = 直前位置
			ENDIF
		ENDIF
	ENDIF
ELSEIF TFLAG:宴会場 == RESULT
	CALL ENKAI_SINKOU()
ENDIF
$END
[IF_DEBUG]
PRINTFORML 移动了{経過時間}次
[ENDIF]

TSP消費倍率 = 5
SIF TALENT:MASTER:100 < -4
	TSP消費倍率 += 15
SIF TFLAG:運搬
	TSP消費倍率 += 3
IF FLAG:70 == 1 || (GETBIT(FLAG:瞬間移動, 1) && !CFLAG:MASTER:同行 && BASE:MASTER:TSP > TSP消費倍率 * 経過時間)
	BASE:MASTER:TSP -= TSP消費倍率 * 経過時間
	SIF TFLAG:運搬
		CFLAG:(TFLAG:運搬):現在位置 = CFLAG:MASTER:現在位置
ELSE
	SIF TALENT:MASTER:100 < -4 && !CFLAG:MASTER:同行
		TIME += 7 * 経過時間
	TIME += 2 * 経過時間
	IF CFLAG:93:同行 && !GETBIT (FLAG:泳池, 0)
		TIME += 2 * 経過時間
		BASE:MASTER:体力 = MAX(BASE:MASTER:体力 - (5 * 経過時間), 500)
	ENDIF
ENDIF
;21/09/01 自由行動に対応するフレーバー追加
IF CFLAG:MASTER:現在位置 == FA16_HOLE:0 && !FA16_HOLE:1
	IF (50 - (ABL:MASTER:戦闘能力 * 7)) < RAND:100
		PRINTFORMW ……脚下有一个落穴、但%CALLNAME:MASTER%毫不费力地避开了
		FA16_HOLE:1 = 1
	ELSE
		PRINTFORMW %CALLNAME:MASTER%掉进了一个落穴中！！
		SELECTCASE RAND(15) + TFLAG:幸運補正
			CASE IS < 2
				PRINTFORML 好痛！！　这么想着的时候屁股已经落地了…
				CALL RECOVER(MASTER, -50, "体力", "屁股痛")
				WAIT
			CASE IS > 12
				MONEY += 100
				PRINTFORML …在穴底发现了100円
				PRINTFORMW 　现在的所持金:%金额表示(MONEY)%
		ENDSELECT
		TIME += 3
		FA16_HOLE:1 = 2
		FA16_HOLE:2 = TIME
	ENDIF
ENDIF

PREVCOM = 400
STR:0 = 移动
;NEXTCOMに何かしらの値が入っている場合はそれを書き換えない
;そうでないばあい-1でリセット
SIF NEXTCOM == 0
	NEXTCOM = -1


;-----------------------------------------------------------
;移動不能時の処理
;ARG=移動しようとした場所ID
;-----------------------------------------------------------
@CANNOT_MOVE_MESSAGE(ARG)
#LOCALSIZE 1
#LOCALSSIZE 1
IF !ARG || NAME_FROM_PLACE(ARG) == "" || TFLAG:移動不能メッセージ == 998
	PRINTFORMW 错误的输入
	CLEARLINE 2
	REUSELASTLINE
ELSEIF TFLAG:移動不能メッセージ == 999
	PRINTFORMW 锁上了
	CLEARLINE 2
	REUSELASTLINE
ELSE
	TRYCALLFORM MAP_CANNOT_WORD_{MAIN_MAP}(ARG)
ENDIF
TFLAG:移動不能メッセージ = 0

;-----------------------------------------------------------
;SKIP_MOVE中止移动时的部分，即STOP跳转的位置
;-----------------------------------------------------------
@qol_SKIP_MOVE_STOP(最終目的地, 直前位置)
#DIM 最終目的地
#DIM 直前位置
#LOCALSIZE 5
#LOCALSSIZE 1
IF IN_TOILET(RESULT)
	CALL 廁所侵入(RESULT)
	SIF RESULT == -1
		CFLAG:MASTER:現在位置 = 直前位置
ELSEIF BATHCHECK(RESULT)
	LOCAL:1 = IN_ROOM_MEMBER("MIN", RESULT, "CFLAG", 6)
	IF !LOCAL:1 && !CFLAG:MASTER:同行
		PRINTFORMW 进入浴场的%CALLNAME:MASTER%泡在了浴池里
	ELSEIF LOCAL:1 && 風呂逐出条件(LOCAL:1) && !CFLAG:MASTER:同行
		PRINTFORMW 被在浴场里的%CALLNAME:(LOCAL:1)%赶出来了…
		CALL KOJO_MESSAGE_SEND("EVENT",11,LOCAL:1,1,0)
		CFLAG:MASTER:現在位置 = 直前位置
	ELSEIF LOCAL:1 && !CFLAG:MASTER:同行
		IF FLAG:70 == 1
			PRINTFORMW %CALLNAME:(LOCAL:1)%在入浴中的样子…
		ELSE
			PRINTFORMW 与在浴场里的%CALLNAME:(LOCAL:1)%对上了视线…
			CALL KOJO_MESSAGE_SEND("EVENT",11,LOCAL:1,2,0)
		ENDIF
		CFLAG:MASTER:現在位置 = 最終目的地
	ELSE
		FOR LOCAL, 1, CHARANUM
			IF 風呂逐出条件(LOCAL) && CFLAG:LOCAL:同行
				PRINTFORMW 共同入浴的邀请被%CALLNAME:LOCAL%拒绝了
				CALL KOJO_MESSAGE_SEND("EVENT",23,LOCAL,1,0)
				CFLAG:MASTER:現在位置 = 直前位置
				;GOTO END
				RETURN
			ELSEIF LOCAL:1 && 風呂逐出条件(LOCAL:1)
				PRINTFORMW 被在浴场里的%CALLNAME:(LOCAL:1)%赶出来了…
				CALL KOJO_MESSAGE_SEND("EVENT",11,LOCAL:1,1,0)
				CFLAG:MASTER:現在位置 = 直前位置
				;GOTO END
				RETURN
			ENDIF
		NEXT
		FOR LOCAL, 1, CHARANUM
			IF CFLAG:LOCAL:同行
				PRINTFORMW %CALLNAME:LOCAL%好像想一起进入浴场的样子
				CALL KOJO_MESSAGE_SEND("EVENT",23,LOCAL,2,0)
				BREAK
			ENDIF
		NEXT
		CFLAG:MASTER:現在位置 = 最終目的地
	ENDIF
ELSEIF RESULT == 54
	CALL 虫かご侵入(RESULT)
	SIF RESULT == -1
		CFLAG:MASTER:現在位置 = 直前位置
;原函数针对可以进入原本锁住的房间，默认家主在屋内睡觉一种对应情况，不管家主实际上在不在家
;默认将玩家视为闯入，仅在MASTER搬入该地点才不会被视为闯入
ELSEIF LOCK:(RESULT)
	LOCAL:2 = 0
	LOCAL:4 = RESULT
	IF FLAG:70 == 1
		FOR LOCAL, 1, CHARANUM
			IF CFLAG:LOCAL:311 == RESULT && CFLAG:LOCAL:睡眠 && !CFLAG:LOCAL:出禁
				PRINTFORMW 好像%CALLNAME:LOCAL%正在睡觉的样子
				LOCAL:2 = 1
			ENDIF
		NEXT
	ELSEIF FLAG:70 == 0
		FOR LOCAL, 1, CHARANUM
			IF CFLAG:LOCAL:311 == RESULT && CFLAG:LOCAL:睡眠 && !CFLAG:LOCAL:出禁
				PRINTFORMW 好像%CALLNAME:LOCAL%正在睡觉的样子
				LOCAL:2 = 1
			;ELSEIF CFLAG:LOCAL:311 == RESULT && !CFLAG:LOCAL:睡眠 && !CFLAG:LOCAL:出禁
			;这里应该是已经进入睡眠时间但仍能互动的一段时间
			ELSEIF CFLAG:LOCAL:311 == RESULT && CFLAG:LOCAL:300 == RESULT && 睡眠時間(LOCAL) && !CFLAG:LOCAL:出禁
				PRINTFORML 好像%CALLNAME:LOCAL%正准备睡觉了
				PRINTFORMW 还能听到一些动静…
				LOCAL:2 = 1
			ENDIF
		NEXT
		;从排除非潜入情况的白名单改为只有上述三种情况才算潜入的黑名单
		IF !LOCAL:2
		;移動成立
		CFLAG:MASTER:現在位置 = 最終目的地
		ELSE
			CALL ASK_YN("潜入房间","算了吧")
			IF RESULT == 0
				CALL 潜入房間(LOCAL:4, 直前位置)
				;GOTO END
				RETURN
			ELSEIF RESULT == 1
				CFLAG:MASTER:現在位置 = 直前位置
			ENDIF
		ENDIF
	ENDIF
ELSEIF TFLAG:宴会場 == RESULT
	CALL ENKAI_SINKOU()
ENDIF

;-----------------------------------------------------------
;SKIP_MOVE结算时间的部分，即END跳转的位置
;-----------------------------------------------------------
@qol_SKIP_MOVE_TIME(経過時間)
#LOCALSIZE 1
#LOCALSSIZE 1
#DIM 経過時間
#DIM TSP消費倍率
TSP消費倍率 = 5
SIF TALENT:MASTER:100 < -4
	TSP消費倍率 += 15
SIF TFLAG:運搬
	TSP消費倍率 += 3
IF FLAG:70 == 1 || (GETBIT(FLAG:瞬間移動, 1) && !CFLAG:MASTER:同行 && BASE:MASTER:TSP > TSP消費倍率 * 経過時間)
	BASE:MASTER:TSP -= TSP消費倍率 * 経過時間
	SIF TFLAG:運搬
		CFLAG:(TFLAG:運搬):現在位置 = CFLAG:MASTER:現在位置
ELSE
	SIF TALENT:MASTER:100 < -4 && !CFLAG:MASTER:同行
		TIME += 7 * 経過時間
	TIME += 2 * 経過時間
	IF CFLAG:93:同行 && !GETBIT (FLAG:泳池, 0)
		TIME += 2 * 経過時間
		BASE:MASTER:体力 = MAX(BASE:MASTER:体力 - (5 * 経過時間), 500)
	ENDIF
ENDIF

;-----------------------------------------------------------
;SKIP_MOVE陷阱的部分，即结算时间之后的部分
;-----------------------------------------------------------
@qol_SKIP_MOVE_HOLE
#LOCALSIZE 1
#LOCALSSIZE 1
;21/09/01 自由行動に対応するフレーバー追加
IF CFLAG:MASTER:現在位置 == FA16_HOLE:0 && !FA16_HOLE:1
	IF (50 - (ABL:MASTER:戦闘能力 * 7)) < RAND:100
		PRINTFORMW ……脚下有一个落穴、但%CALLNAME:MASTER%毫不费力地避开了
		FA16_HOLE:1 = 1
	ELSE
		PRINTFORMW %CALLNAME:MASTER%掉进了一个落穴中！！
		SELECTCASE RAND(15) + TFLAG:幸運補正
			CASE IS < 2
				PRINTFORML 好痛！！　这么想着的时候屁股已经落地了…
				CALL RECOVER(MASTER, -50, "体力", "屁股痛")
				WAIT
			CASE IS > 12
				MONEY += 100
				PRINTFORML …在穴底发现了100円
				PRINTFORMW 　现在的所持金:%金额表示(MONEY)%
		ENDSELECT
		TIME += 3
		FA16_HOLE:1 = 2
		FA16_HOLE:2 = TIME
	ENDIF
ENDIF
