@出産経過(ARG)
#DIM CHILDNUM
#DIM D_BEFORE
#DIM nCurrentChildCareCount
#DIM nCurrentCareChild
#DIM DYNAMIC DADDY

IF CFLAG:ARG:妊娠経過日数 > 0
	D_BEFORE = CFLAG:ARG:妊娠経過日数
	CFLAG:ARG:妊娠経過日数 += FLAG:妊娠日程倍率 + 1
	FOR LOCAL,20,72
		SIF !GROUPMATCH(LOCAL, 20, 30, 40, 60, 71)
			CONTINUE
		CALL PREG_DAY_ADJUSTER(ARG, LOCAL, D_BEFORE, CFLAG:ARG:妊娠経過日数)
	NEXT
ENDIF
	;egg laying.
SIF TALENT:ARG:NESTING > 0
	TALENT:ARG:NESTING += FLAG:妊娠日程倍率 + 1
SIF CFLAG:ARG:育児人数 > 0 && CFLAG:ARG:出産経過日 == 0 ;failsafe
	CFLAG:ARG:出産経過日 = 19 ;set to pre-recovery so it becomes 20

SIF CFLAG:ARG:妊娠経過日数 > 0
	DADDY = CFLAG:ARG:誰の子
SIF CFLAG:ARG:出産経過日 > 0
	CFLAG:ARG:出産経過日 += FLAG:妊娠日程倍率 + 1
	;additional pregnancies or eggs.
CALL PROGRESS_PREGNANCIES(ARG)
;potentially, even if these counters misbehave, because we check birthdays the events will popup properly anyway and process all children of a 2hu
nCurrentChildCareCount = CFLAG:ARG:出産経過日
nCurrentCareChild = TALENT:ARG:育児中

FOR LOCAL,MAX(CFLAG:ARG:子供人数 - MAXCHILD + 1, 1),CFLAG:ARG:子供人数 + 1 ;bug fix loop, process all children
	CHILDNUM = CHILD_INDEX(LOCAL)
	SIF CHILDNUM >= VARSIZE("CHILDNAME")
		BREAK
	SIF CHILDNAME:ARG:CHILDNUM == ""
		CONTINUE
	TALENT:ARG:育児中 = CHILDNUM
	CFLAG:ARG:出産経過日 = (DAY-CHILD_BIRTHDAY:ARG:CHILDNUM)+1 ;their current growth counter/age

	SIF CFLAG:ARG:出産経過日 > 0
		DADDY = CHILD_DADDY:ARG:CHILDNUM

	;子離れ
	IF CFLAG:ARG:出産経過日 >= CHILD_自立 && !CHILD_INDEPENDENT:ARG:CHILDNUM
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック,存在しないならRESULT=2,以下同様
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_自立")
		IF RESULT == 2
			PRINTFORMW %CALLNAME:ARG%和%CALLNAME:DADDY%的孩子%CHILDNAME:ARG:CHILDNUM%平安的迎来了独自生活的日子、自立了。
			PRINTFORML 
			PRINTFORML 希望能偶尔见见面
			PRINTFORML %CALLNAME:MASTER%的愿望还是没能说出口……。
			PRINTFORMW 
		ENDIF
		CFLAG:ARG:育児人数 -= 1
		CFLAG:DADDY:育児人数 -= 1
		;IF CFLAG:ARG:育児人数 >= 0
		IF CHILD_MULTIPLE_LAST(ARG,CHILDNUM) == CHILDNUM && RESULT == 2
				;only after the last child in a litter.
			IF CFLAG:ARG:育児人数 > 0
				;PRINTFORML 遠くなる子の背中を見ながらまだ小さい他の兒童も無事に育てようと、
				PRINTFORML 看着逐渐远去的孩子、
				PRINTFORML 希望还小的孩子能顺利成长、
				;PRINTFORML %CALLNAME:ARG%は%CALLNAME:DADDY%と静かに誓った。
				PRINTFORMW %CALLNAME:ARG%握着%CALLNAME:DADDY%的手、默默祈愿。
			ELSE
				;PRINTFORML 远くなる子の背中を见ながら%CALLNAME:ARG%は%CALLNAME:DADDY%とこどもの无事を祈った。
				PRINTFORMW 看着远去的孩子的背影，%CALLNAME:ARG%和%CALLNAME:DADDY%祈祷着孩子平安。
			ENDIF
			;PRINTFORML 別れ際、兒童は%CALLNAME:DADDY%が%CALLNAME:ARG%を顧みず他の女の尻を追い回していたことを口汚く罵り、
			;PRINTFORML 自分は絶対に%CALLNAME:DADDY%のようにはならないと吐き捨てて去っていった
			CALL ASK_DIARY(@"%CHILDNAME:ARG:CHILDNUM%%COND_STR("たち", CHILD_MULTIPLE_COUNT(ARG,CHILDNUM) > 1)%が独り立ちした。")
		ENDIF
		CHILD_INDEPENDENT:ARG:CHILDNUM = 1
		;SIF CFLAG:ARG:育児人数 == 0
		;	TALENT:ARG:育児中 = 0
		;SIF	CFLAG:DADDY:育児人数 == 0
		;	TALENT:DADDY:育児中 = 0
		;CFLAG:ARG:出産経過日 = 0
		;自立するときに再度設定する
		CALL 自立先選定(ARG, CHILDNUM)
	ENDIF
	IF CFLAG:ARG:出産経過日 == CHILD_自立前
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_自立前")
		IF RESULT == 2
			PRINTFORML %CHILDNAME:ARG:CHILDNUM%还有一段时间就要分别了。
			PRINTFORML 个子也长高了、已经和%CALLNAME:ARG%差不多了。
			PRINTFORMW 这个孩子不久也要离开家门了吧、要好好珍惜剩下的时间……。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_就学
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_就学")
		IF RESULT == 2
			PRINTFORML %CALLNAME:ARG%的孩子%CHILDNAME:ARG:CHILDNUM%开始上私塾了。
			PRINTFORML 孩子的成长很迅速。
			PRINTFORML 离开父母的那天很快就会到来的吧……。
			PRINTFORMW %CALLNAME:DADDY%变得有些伤感。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_しつけ
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_しつけ")
		IF RESULT == 2
			PRINTFORML %CHILDNAME:ARG:CHILDNUM%越来越聪明了、做出了各种各样的行动、
			PRINTFORML 同时恶作剧和任性次数也增加了。
			PRINTFORMW 必须要认真考虑教育的事了……。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_語彙
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_語彙")
		IF RESULT == 2
			PRINTFORML %CHILDNAME:ARG:CHILDNUM%的词汇量增加了。
			PRINTFORMW 说的内容只是单独的２、３个音节完全无法形成句子。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_喋る
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_喋る")
		IF RESULT == 2
			PRINTFORML %CALLNAME:ARG%以惊人的气势跑了过来。
			PRINTFORML %CHILDNAME:ARG:CHILDNUM%呼喊了%CALLNAME:ARG%的名字。
			PRINTFORML 赶紧去看看、确实在看着%CALLNAME:ARG%的脸喊著名字。
			PRINTFORMW %CALLNAME:DADDY%为了听见孩子叫自己、把脸靠过去也听见了连喊爸爸的声音。
		ENDIF
	;stop this message from overriding previous growth messages if the previous growth lengths are set low.
	ELSEIF (CHILD_喋る > CHILD_よちよち+3 && INRANGE(CFLAG:ARG:出産経過日, CHILD_喋る - 3, CHILD_喋る - 1)) || (CHILD_喋る > CHILD_よちよち+1 && CFLAG:ARG:出産経過日 == CHILD_喋る-1)
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_会話寸前")
		IF RESULT == 2
			PRINTFORML 最近%CHILDNAME:ARG:CHILDNUM%常常张口说话。
			PRINTFORML 虽然说不出意义清楚的话、只能用手指着想要的东西喊著名字、以此表达自己的意思。
			PRINTFORMW 不久就能说出清楚的话吧……。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_よちよち
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_よちよち")
		IF RESULT == 2
			PRINTFORML %CHILDNAME:ARG:CHILDNUM%用双脚站立开始摇摇晃晃的走路了。
			PRINTFORML 因为视线和行动半径的扩大对各种各样的事情产生了兴趣。
			PRINTFORMW %CALLNAME:MASTER%牵着还在摇摇晃晃的%CHILDNAME:ARG:CHILDNUM%的手移动到了各种地方。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_つかまり立ち
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_つかまり立ち")
		IF RESULT == 2
			PRINTFORML %CALLNAME:MASTER%蹲了下去让%CHILDNAME:ARG:CHILDNUM%握住手指。
			PRINTFORMW 然后慢慢地抬起手指、做着站立的练习。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_玩具
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_玩具")
		IF RESULT == 2
			PRINTFORML 为了%CHILDNAME:ARG:CHILDNUM%玩耍%CALLNAME:MASTER%用木头制作了简单的玩具。
			PRINTFORML 反正肯定会被扔来扔去所以只要单纯的做结实就好。
			PRINTFORMW 为了不让孩子受伤、%CALLNAME:MASTER%仔细的打磨着断面。
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == CHILD_離乳
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_離乳")
		IF RESULT == 2
			PRINTFORMW 刚刚断奶的婴儿满脸笑容的样子让%CALLNAME:MASTER%嘴角上扬。
		ENDIF
		IF CHILD_MULTIPLE_LAST(ARG,CHILDNUM) == CHILDNUM
				;only after the last child in a litter.
			PRINTFORML %CALLNAME:ARG%的哺乳期结束了。
			IF TALENT:ARG:母乳体質 == 1 && EXP:ARG:噴乳経験 > 500 && EXP:ARG:出産経験 > 1
				PRINTFORML 然而，%CALLNAME:ARG%的乳房持续分泌着超出哺乳期所需的大量母乳，至今仍在不断产出营养丰富的乳汁……
				PRINTFORMW %CALLNAME:ARG%得到【母乳体质】
				TALENT:ARG:母乳体質 = 2
			ELSEIF TALENT:ARG:母乳体質 == 2
				PRINTFORM 完成使命的%CALLNAME:ARG%
				IF CFLAG:ARG:乳品质提升 && TALENT:ARG:バストサイズ > -2
					PRINTFORMW 的胸部虽然稍微变小了，但母乳仍在分泌。
				ELSE
					PRINTFORMW 的母乳仍在分泌。
				ENDIF
			ELSE
				PRINTFORMW 完成使命的%CALLNAME:ARG%\@ CFLAG:ARG:乳品质提升 && TALENT:ARG:バストサイズ > -2 ? 的胸部变小了，母乳也停止了 # 的母乳停止了 \@。
				SIF TALENT:ARG:母乳体質 == 1
					TALENT:ARG:母乳体質 = 0
			ENDIF
			;乳品质提升フラグたってて、今絶壁じゃないなら小さくなる。通常出産以外の妊娠終了なんかも考慮するとCALLで呼び出す方が良いのだろうが…
			IF CFLAG:ARG:乳品质提升 > 0 && TALENT:ARG:胸圍 > -2
				TALENT:ARG:胸圍 -= 1
				CFLAG:ARG:乳品质提升 --
			ENDIF
		ENDIF
	ELSEIF CFLAG:ARG:出産経過日 == 20 && CFLAG:ARG:回復速度降低
		SIF CHILD_MULTIPLE_FIRST(ARG,CHILDNUM) == CHILDNUM
				;only print a line for the first child of a litter.
			DRAWLINE
		PRINTFORMW 在平安完成产后恢复后、%CALLNAME:ARG%完全恢复了元气。
		;口上チェック
		CALL KOJO_MESSAGE_SEND("CHILD", 0, ARG, 0, 0, "RAISING_回復")
		IF RESULT == 2
			;体質変化があるので省略しない
		ENDIF
		IF CHILD_MULTIPLE_LAST(ARG,CHILDNUM) == CHILDNUM
				;only after the last child in a litter.
			MAXBASE:ARG:体力 += 500
			MAXBASE:ARG:気力 += 500
			SIF MAXBASE:ARG:体力 / 10 * 11 <= CSVBASE(ARG, GETNUM(BASE, "体力")) * 2
				MAXBASE:ARG:体力 = MAXBASE:ARG:体力 / 10 * 11
			SIF MAXBASE:ARG:気力 / 10 * 11 <= CSVBASE(ARG, GETNUM(BASE, "気力")) * 2
				MAXBASE:ARG:気力 = MAXBASE:ARG:気力 / 10 * 11
			TALENT:ARG:回復速度 = CFLAG:ARG:回復速度降低 - 2
			CFLAG:ARG:回復速度降低 = 0
		ENDIF
	ENDIF
NEXT

;bug fix, set counter to latest progress of the last child
IF CFLAG:ARG:育児人数 > 0
	CFLAG:ARG:出産経過日 = nCurrentChildCareCount
	TALENT:ARG:育児中 = nCurrentCareChild
ELSE
	CFLAG:ARG:出産経過日 = 0
	TALENT:ARG:育児中 = 0
ENDIF
;Moved to make child growth stage length settings accurate, added egg laying check.
SIF CFLAG:ARG:妊娠経過日数 > 100 || TALENT:ARG:NESTING > 100
	CALL BIRTH(ARG)
SIF CFLAG:ARG:妊娠経過日数 > 1 || TALENT:ARG:NESTING == 60
	CALL PERCIEVE(ARG)

;bug fix
@EVENTLOAD
#DIM DYNAMIC CHANGES
FOR LOCAL, 1, CHARANUM - 1
	IF CFLAG:LOCAL:子供人数 > 0
		FOR COUNT, 1, MAXCHILD + 1
			SIF CHILDNAME:LOCAL:COUNT == ""
				CONTINUE
			IF CHILD_BIRTHDAY:LOCAL:COUNT > 0 && (DAY-CHILD_BIRTHDAY:LOCAL:COUNT)+1 > CHILD_自立 && !CHILD_INDEPENDENT:LOCAL:COUNT
				PRINTFORMDL 正在设置%CALLNAME:LOCAL%的子女%CHILDNAME:LOCAL:COUNT%的独立标志。
				CHILD_INDEPENDENT:LOCAL:COUNT = 1
				CHANGES = 1
			ENDIF
		NEXT
	ENDIF
NEXT

;SIF CHANGES && !CHECK_UPDATE("4.975") ;saves prior to this need converting, everywhere else indicates an error somewhere
;	CALL COLORMESSAGE("＊警告＊ CHILD_INDEPENDENT 设置不正确，已进行调整。请报告此问题。", C_RED, 2)

;子供が通学するか
@GO_SCHOOL(ARG)
#FUNCTION
SIF !INRANGE(DAY % 7, 1, 5) 
	RETURNF 0
SIF FESTIVAL() != ""
	RETURNF 0
SIF !TALENT:ARG:育児中
	RETURNF 0
;大雨と吹雪
SIF TIME:5 == 5
	RETURNF 0
SIF TIME:5 == 9
	RETURNF 0
SIF CFLAG:ARG:出産経過日 >= CHILD_就学
	RETURNF 1

;現在育児中の兒童の名前を表示
@SHOW_CHILDNAME(ARG)
#FUNCTIONS
RETURNF CHILDNAME:ARG:(TALENT:ARG:育児中)

;成長した兒童と親を随机で拾ってくる関数
;4.975JPAnon修正：随机抽选母亲变成随机抽取每一个儿童
@PickRandGrownChild
#DIM DYNAMIC SHUFFLED_CHILDREN, 100 ;shuffling a hundred kids should be enough
#DIM DYNAMIC ARRAY_INDEX
SIF !CFLAG:MASTER:子供人数
	RETURN -1
CALL FISHER_YATES_SHAFFLE(CHARANUM - 1)
FOR LOCAL:10, 0, CHARANUM - 1
	LOCAL = SHAFFLE_ARRAY:(LOCAL:10) + 1

	FOR LOCAL:1, 1, MAXCHILD + 1
		IF CHILDNAME:LOCAL:(LOCAL:1) != "" && CHILD_INDEPENDENT:LOCAL:(LOCAL:1)
			SHUFFLED_CHILDREN:(ARRAY_INDEX++) = LOCAL:1 * 1000 + LOCAL
			SIF ARRAY_INDEX >= 100
				BREAK
		ENDIF
	NEXT
	SIF ARRAY_INDEX >= 100
		BREAK
NEXT
SIF ARRAY_INDEX == 0
	RETURN -1
LOCAL = SHUFFLED_CHILDREN:(RAND:ARRAY_INDEX)

RETURN LOCAL % 1000, LOCAL / 1000

;-----------------------------------------------------
;自立した兒童の自立先を決める関数
;-----------------------------------------------------
@自立先選定(CHARA, CHILDNUM)
#DIM CHARA
#DIM CHILDNUM
{
#DIM CONST VALID_AREAS = 
	神社境内, 神社本堂, 夢幻遺跡, 命蓮寺境内, 命蓮寺方丈, 神霊廟広場, 神霊廟道場, 広場, 商家町, 呑屋小道, 大廳, 食堂, 大図書館,
	斜角的竹林, 永遠亭, 夢幻館, 香霖堂, 中有之道, 三途之川, 彼岸, 白玉楼庭, 畜生界, 玄武之澤, 間欠泉地下中樞,
	九天瀑布, 守矢神社境内, 守矢神社本殿, 旧地獄街道, 地霊殿, 灼熱地獄跡, 月之都, 玉兎之街
}
CHILD_AREA:CHARA:CHILDNUM = VALID_AREAS:(RAND:32)

@PREG_DAY_ADJUSTER(C_ID, ADJUST_TO, D_BEFORE, D_AFTER)
#DIM ADJUST_TO
#DIM C_ID
#DIM D_BEFORE
#DIM D_AFTER
SIF D_BEFORE < ADJUST_TO && D_AFTER >= ADJUST_TO
	CFLAG:C_ID:妊娠経過日数 = ADJUST_TO