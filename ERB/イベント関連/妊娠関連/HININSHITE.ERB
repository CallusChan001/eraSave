@HININSHITE(ARG)

IF ESTRUS_CYCLE(ARG) == 150
	LOCALS = 是危险日
ELSEIF ESTRUS_CYCLE(ARG) != 15
	LOCALS = 不在安全期
ENDIF

IF SELF_PREGNANCY && GROUPMATCH(SELECTCOM, 64, 130, 131, 132, 133)
	PRINTFORML %CALLNAME:MASTER%因为今天%LOCALS%而提出希望做避孕措施…
	{
		CALL ASK_M("放弃",1,@"给%CALLNAME:TARGET%使用避孕套（剩余{ITEM:45}枚）",ITEM:45,@"喝避孕药（剩余{ITEM:49}颗）",ITEM:49,@"给避孕药（假）（剩余{ITEM:49}颗）",ITEM:49,
		@"想要怀上%CALLNAME:TARGET%的孩子", !TCVAR:懇願, "老娘就是要定了你的种", (TEQUIP:TARGET:縄 || TEQUIP:TARGET:拘束 || CFLAG:TARGET:败犬))
	}

ELSE
	PRINTFORML %CALLNAME:ARG%因为今天%LOCALS%而提出希望做避孕措施…
	CALL KOJO_MESSAGE_SEND("EVENT",18,ARG,1,0)
	{
		CALL ASK_M("放弃",1,@"使用避孕套（剩余{ITEM:45}枚）",ITEM:45,@"给避孕药（剩余{ITEM:49}颗）",ITEM:49,@"给避孕药（假）（剩余{ITEM:49}颗）",ITEM:49,
		"请求不戴套做", !TCVAR:懇願, "不、绝对要让你怀孕", (TEQUIP:ARG:縄 || TEQUIP:ARG:拘束 || CFLAG:ARG:败犬),
	"请让我不戴套,我会拔出来的", 1)
	}
ENDIF
IF RESULT == 1
	ITEM:45 -= 1
	IF SELF_PREGNANCY && GROUPMATCH(SELECTCOM, 64, 130, 131, 132, 133)
		PRINTFORML 给%CALLNAME:TARGET%戴上了避孕套
		TEQUIP:TARGET:避孕套 = 1
	ELSE
		PRINTL 戴上了避孕套
		TEQUIP:MASTER:避孕套 = 1
	ENDIF
ELSEIF RESULT == 2
	ITEM:49 -= 1
	IF SELF_PREGNANCY && GROUPMATCH(SELECTCOM, 64, 130, 131, 132, 133)
		TCVAR:MASTER:口服避孕薬 = 1
		PRINTFORML 给%CALLNAME:MASTER%喝了避孕药 
	ELSE
		TCVAR:ARG:口服避孕薬 = 1
		PRINTFORML 给%CALLNAME:ARG%喝了避孕药 
	ENDIF
;魔改假避孕药
ELSEIF RESULT == 3
	CALL FAKE_CONTRACEPTIVE
ELSEIF RESULT == 4
	TCVAR:ARG:懇願 = 1
	CALL OGAMITAOSHI(ARG)
	SIF RESULT == -1
		RETURN -1
ELSEIF RESULT == 5
	TCVAR:ARG:强行 = 1
ELSEIF RESULT == 6
	CALL OGAMITAOSHI2(ARG)
ELSE
	PRINTFORML 虽然很遗憾但是还是放弃吧
	RESULT = -1
	RETURN -1
ENDIF

@避孕要求(ARG)
;魔改修正口服避孕药（假）被重复要求避孕，之前修过一次，请勿再次删除。
SIF TCVAR:ARG:口服避孕药（假） == 1
	RETURN
SIF CFLAG:ARG:允许无套 == 2
	RETURN
SIF !妊娠可否(ARG)
	RETURN
SIF !HAS_PENIS(MASTER) && !HAS_PENIS(ARG)
	RETURN
SIF TALENT:ARG:無知
	RETURN
SIF TFLAG:16
	RETURN
SIF TCVAR:ARG:强行
	RETURN
SIF !SHIRAHU(ARG)
	RETURN
SIF TCVAR:ARG:挿入拒絶
	RETURN -1
;安全日
SIF ESTRUS_CYCLE(ARG) == 15
	RETURN
;外に出すから
SIF TCVAR:外に出すから
	RETURN
IF !CFLAG:ARG:允许无套
	CALL HININSHITE(ARG)
ELSEIF ESTRUS_CYCLE(ARG) == 150
	CALL HININSHITE(ARG)
ENDIF
SIF RESULT == -1
	RETURN -1


@妊娠可否(ARG)
#FUNCTION
IF SELF_PREGNANCY && GROUPMATCH(SELECTCOM, 64, 130, 131, 132, 133)
	SIF TEQUIP:ARG:避孕套 || TCVAR:MASTER:口服避孕薬
		RETURNF 0
ELSE
	SIF TEQUIP:MASTER:避孕套 || TCVAR:ARG:口服避孕薬
		RETURNF 0
ENDIF
SIF TALENT:ARG:幼稚 && !TALENT:ARG:初潮
	RETURNF 0
SIF ((CHECK_CHARA(ARG, "幽霊") || CHECK_CHARA(ARG, "人形") || CHECK_CHARA(ARG, "蓬莱人")) && !CFLAG:ARG:兒童人数) || TALENT:ARG:妊娠
	RETURNF 0
RETURNF 1

@AUTO_CONTRACEPTION(ARG)
IF CFLAG:ARG:妊娠経過日数 <= 30 && TALENT:ARG:妊娠 && CFLAG:ARG:妊娠経過日数 >= 4
	PRINTFORMW 到安定期之前还是不要了
	RETURN -1
ENDIF
IF CFLAG:ARG:妊娠経過日数 > 70 && TALENT:ARG:妊娠
	PRINTFORMW 因为担心小孩所以还是不要了
	RETURN -1
ENDIF
SIF !TALENT:ARG:育児中
	RETURN
SIF !HAS_PENIS(MASTER) && !HAS_PENIS(TARGET)
	RETURN
;魔改假避孕药
IF SELF_PREGNANCY && GROUPMATCH(SELECTCOM, 64, 130, 131, 132, 133)
	SIF TEQUIP:TARGET:避孕套 || TCVAR:MASTER:口服避孕薬 || TCVAR:TARGET:口服避孕药（假）
		RETURN
ELSE
	SIF TEQUIP:MASTER:避孕套 || TCVAR:TARGET:口服避孕薬 || TCVAR:MASTER:口服避孕药（假）
		RETURN
ENDIF
SIF CFLAG:ARG:出産経過日 >= CHILD_就学
	RETURN
IF SELF_PREGNANCY && GROUPMATCH(SELECTCOM, 64, 130, 131, 132, 133)
	PRINTFORML 因为不想给育儿中的%CALLNAME:MASTER%增加负担所以还是避孕吧
	CALL ASK_M(@"给%CALLNAME:TARGET%戴避孕套",ITEM:避孕套,"喝口服避孕药",ITEM:口服避孕薬,"放弃",1)
	SELECTCASE RESULT
		CASE 0
			ITEM:避孕套 --
			TEQUIP:TARGET:避孕套 = 1
			PRINTFORML 给%CALLNAME:TARGET%戴上了避孕套
			RETURN 1
		CASE 1
			ITEM:口服避孕薬 --
			TCVAR:PLAYER:口服避孕薬 = 1
			PRINTFORML 喝了避孕药 
			RETURN 1
		CASE 2
			PRINTFORML 虽然很遗憾但是还是放弃了
			RETURN -1
	ENDSELECT
ELSE
	PRINTFORML 因为不想给育儿中的%CALLNAME:ARG%增加负担所以还是避孕吧
	CALL ASK_M("戴避孕套",ITEM:避孕套,@"给%CALLNAME:TARGET%喝口服避孕药",ITEM:口服避孕薬,"放弃",1)
	SELECTCASE RESULT
		CASE 0
			ITEM:避孕套 --
			TEQUIP:PLAYER:避孕套 = 1
			PRINTL 戴上了避孕套
			RETURN 1
		CASE 1
			ITEM:口服避孕薬 --
			TCVAR:ARG:口服避孕薬 = 1
			PRINTFORML 给%CALLNAME:ARG%喝了避孕药 
			RETURN 1
		CASE 2
			PRINTFORML 虽然很遗憾但是还是放弃了
			RETURN -1
	ENDSELECT
ENDIF

@ChkBeforeInsert(ARG)
CALL AUTO_SKIN_EQUIP
IF GROUPMATCH(TALENT:ARG:処女, 1, -1)
	CALL LOST_VIRGIN_STOP(ARG)
	SIF RESULT == -1
		RETURN -1
ENDIF
CALL AUTO_CONTRACEPTION(ARG)
SIF RESULT == -1
	RETURN -1
CALL 避孕要求(ARG)
IF RESULT == -1
	RETURN -1
ENDIF
