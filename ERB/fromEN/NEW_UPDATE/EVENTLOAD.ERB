;warning for the faulty cflag value
@EVENTLOAD
#LATER

LOCALS '= ""
LOCAL:1 = 0
FOR LOCAL, 1, CHARANUM
	;don't bother if the value is not tampered with
	SIF !CFLAG:LOCAL:口上セレクタ
		CONTINUE
	;check if the main dialogue still works with it
	TRYCCALLFORM M_KOJO_K{NO:LOCAL}_{CFLAG:LOCAL:口上セレクタ}
		IF !RESULT
			LOCAL:1 ++
			LOCALS += CALLNAME:LOCAL + "、"
			剧本错误警告:LOCAL = 1
		ENDIF
	CATCH
		LOCAL:1 ++
		LOCALS += CALLNAME:LOCAL + "、"
		剧本错误警告:LOCAL = 1
	ENDCATCH
NEXT
IF LOCAL:1
	CALL COLORMESSAGE("警告！CFLAG剧本选择的值无效！",C_RED,2,1)
	PRINTFORML 角色数量: {LOCAL:1}
	PRINTFORML 受影响的角色: %LIST_IN_STRING(LOCALS)%
	CALL COLORMESSAGE("请在[500]UPDATE中确认并重选剧本\n由于剧本运作异常，重选时需解除无剧本角色过滤功能",C_RED,2,1)
ENDIF

;fix unset dick size tweak and etc
@EVENTLOAD
#LATER
FOR LOCAL, 0, CHARANUM
	SIF !HAS_PENIS(LOCAL)
		CONTINUE
	IF TALENT:LOCAL:形状 <= 0 || MAXBASE:LOCAL:精力 <= 0 || MAXBASE:LOCAL:勃起 <= 0
		CALL COLORMESSAGE(@"%CALLNAME:LOCAL%的鸡鸡信息修正中...",C_YELLOW,1,1)
		SIF TALENT:LOCAL:形状 <= 0
			TALENT:LOCAL:形状 = 3
		SIF MAXBASE:LOCAL:勃起 <= 0
			MAXBASE:LOCAL:勃起 = 1500
		IF MAXBASE:LOCAL:精力 <= 0
			;custom code
			;IF nFutaVig
				;MAXBASE:LOCAL:精力 = 9999
			;ELSE
				MAXBASE:LOCAL:精力 = 1000
			;ENDIF
		ENDIF
	ENDIF
	IF LOCAL == MASTER && MAXBASE:LOCAL:精力 == 1000 ;give back bonus vig the game owes you if you're at base VIG
		;CALL Pc_Vig_Recover(MASTER)
	ENDIF
	;===== custom code =====
	;IF TALENT:LOCAL:絶倫 && MAXBASE:LOCAL:勃起 == 1500 ;addition custom code
		;CALL COLORMESSAGE(@"%CALLNAME:LOCAL%の勃起力を修正中...",C_YELLOW,1,1)
		;MAXBASE:LOCAL:勃起 *= 2
	;ENDIF
	;=======================
NEXT

@EVENTLOAD
#LATER
IF !RANDOM_CHARANUM
	CALL COLORMESSAGE("路人角色编号出错了，请执行一次UPDATE", C_RED, 1)
	FORCEWAIT
ENDIF

[SKIPSTART]
@EVENTLOAD
IF !EXISTFUNCTION("Add_Duplicate_Character")
    FOR LOCAL, CHARANUM-1, 0, -1
        IF TALENT:LOCAL:恋慕 > 1
            PRINTFORML このバージョンはDeep Loveをサポートしていません。%CALLNAME:LOCAL%({LOCAL})の恋慕素質を1にします。
            TALENT:LOCAL:恋慕 = 1
        ENDIF
        IF CFLAG:LOCAL:9102 ;is duplicate
            PRINTFORML このバージョンは分身をサポートしていません。%CALLNAME:LOCAL%({LOCAL})の分身を削除します。
            DELCHARA LOCAL
        ENDIF
    NEXT
ENDIF
[SKIPEND]